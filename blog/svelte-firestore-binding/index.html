<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="description" content="Pain-free interview transcription for researchers with Lexoral. We give you an AI assistant that does the tedious bits for you, and asks for help where needed." />
    <link rel="icon" href="/favicon.png" />
    <link rel='stylesheet' href='/global.css' />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes" />
		<meta http-equiv="content-security-policy" content=""><title>Database sync like magic, with Svelte + Firestore</title><meta name="description" content="Both Firestore and Svelte are event-driven and reactive. By forgetting everything we know about data layers and building one from first principles, we&#39;ve made it easy to synchronise data both ways between the browser and the database."><link rel="alternate" type="application/rss+xml" href="https://lexoral.com/rss.xml" title="Lexoral Blog"><link rel="canonical" href="https://lexoral.com/blog/svelte-firestore-binding"><meta property="og:title" content="Database sync like magic, with Svelte + Firestore"><meta property="og:description" content="Both Firestore and Svelte are event-driven and reactive. By forgetting everything we know about data layers and building one from first principles, we&#39;ve made it easy to synchronise data both ways between the browser and the database."><meta property="og:image" content="https://lexoral.com/assets/blog/svelte-firestore-binding/header.png"><meta property="og:type" content="article"><meta property="og:site_name" content="Lexoral"><meta property="og:url" content="https://lexoral.com/blog/svelte-firestore-binding"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@Lexoral"><meta name="twitter:image" content="https://lexoral.com/assets/blog/svelte-firestore-binding/header.png"><meta name="twitter:creator" content="@SteWaterman">
	<link rel="stylesheet" href="/_app/assets/vendor-ec9510ad.css">
	<link rel="stylesheet" href="/_app/assets/BlogPost-5fce1195.css">
	<link rel="stylesheet" href="/_app/assets/Template-e715207d.css">
	<link rel="stylesheet" href="/_app/assets/TextContainer-83cfe010.css">
	<link rel="stylesheet" href="/_app/assets/DiagonalSection-06901f00.css">
	<link rel="stylesheet" href="/_app/assets/Snippet-ebb7e52a.css">
	</head>
	<body>
		






<div class="gradient svelte-1thle15"><div class="panX svelte-1atbztl"><div class="panY svelte-1atbztl"><div class="gradient svelte-1atbztl"></div></div></div></div>

<nav class="svelte-1876kbr"><a class="logoLink svelte-1876kbr" href="/"><img class="logo svelte-1876kbr" src="/assets/smallBrand_white.svg" alt="The Lexoral logo"></a>

  <div class="burgerMenuContainer svelte-1876kbr"><span tabindex="0" class="burgerMenuOpen svelte-1876kbr"><svg id="" class="svelte-fa svelte-1cj2gr0" style="height:1em;vertical-align:-.125em;transform-origin:center;overflow:visible" viewBox="0 0 448 512" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg"><g transform="translate(224 256)" transform-origin="112 0"><g transform="translate(0,0) scale(1,1)"><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z" fill="currentColor" transform="translate(-224 -256)"></path></g></g></svg></span>

    <ul class="menu svelte-1876kbr"><li class="svelte-1876kbr"><span class="label svelte-101pjyx"><a class="topLink svelte-101pjyx" href="/#how-it-works">About</a>
  <div class="menu svelte-101pjyx"><div class="menu-arrow svelte-101pjyx"><div class="menu-arrow-fill svelte-101pjyx"></div></div>
      <div class="menu-content svelte-101pjyx"><ul class="svelte-101pjyx"><li class="menuEntry svelte-101pjyx"><a class="menuLink svelte-101pjyx" href="/#how-it-works">How it Works</a>
            </li><li class="menuEntry svelte-101pjyx"><a class="menuLink svelte-101pjyx" href="/#use-cases">Use Cases</a>
            </li><li class="menuEntry svelte-101pjyx"><a class="menuLink svelte-101pjyx" href="/#community">History</a>
            </li><li class="menuEntry svelte-101pjyx"><a class="menuLink svelte-101pjyx" href="/demo" rel="external">Try a Demo</a>
            </li></ul></div></div></span></li>
      
      <li class="svelte-1876kbr"><span class="label svelte-101pjyx"><a class="topLink svelte-101pjyx" href="/#community">Community</a>
  <div class="menu svelte-101pjyx"><div class="menu-arrow svelte-101pjyx"><div class="menu-arrow-fill svelte-101pjyx"></div></div>
      <div class="menu-content svelte-101pjyx"><ul class="svelte-101pjyx"><li class="menuEntry svelte-101pjyx"><a class="menuLink svelte-101pjyx" href="https://join.slack.com/t/lexoral-users/shared_invite/zt-yk0j76n5-KcQwnmCJ7FKkLsj_ik05Pw" rel="external">Slack</a>
            </li><li class="menuEntry svelte-101pjyx"><a class="menuLink svelte-101pjyx" href="https://twitter.com/lexoral/" rel="external">Twitter</a>
            </li><li class="menuEntry svelte-101pjyx"><a class="menuLink svelte-101pjyx" href="https://github.com/stevenwaterman/Lexoral/" rel="external">GitHub</a>
            </li><li class="menuEntry svelte-101pjyx"><a class="menuLink svelte-101pjyx" href="https://www.twitch.tv/lexoral/" rel="external">Twitch</a>
            </li></ul></div></div></span></li>
      
      <li class="svelte-1876kbr"><span class="label svelte-101pjyx"><a class="topLink svelte-101pjyx" href="/blog">Blog</a>
  </span></li>
      
      <li class="svelte-1876kbr"><span class="label svelte-101pjyx"><a class="topLink svelte-101pjyx" href="/#pricing">Pricing</a>
  </span></li>
      
      <li class="signIn svelte-1876kbr"><a id="signin" class="LinkButton svelte-tlnb84" rel="external" href="/dashboard" target="_self">Sign inÂ <span class="arrow svelte-tlnb84">&gt;</span></a></li></ul></div></nav>

<div class="column svelte-1thle15"><div class="grid svelte-1e763kd"><div class="textContainer svelte-11sshxl" style=""><article class="svelte-1e763kd"><a href="/assets/blog/svelte-firestore-binding/header.png"><img class="headerImage svelte-1e763kd" src="/assets/blog/svelte-firestore-binding/header.png" style="object-fit: cover; object-position: bottom;" alt="Header"></a>
        <div class="padded svelte-1e763kd"><div class="metadata svelte-1e763kd"><p class="type svelte-1e763kd">tech</p>
            <p class="date svelte-1e763kd">Published <time>2022-02-16</time></p>
            <p class="author svelte-1e763kd">By Steven Waterman</p></div>

          <h1 class="svelte-1e763kd">Database sync like magic, with Svelte + Firestore</h1>
          <summary class="svelte-1e763kd">Both Firestore and Svelte are event-driven and reactive. By forgetting everything we know about data layers and building one from first principles, we&#39;ve made it easy to synchronise data both ways between the browser and the database.</summary>

          
          <hr class="svelte-1e763kd">

          <p>I&#39;ve always been weirdly fascinated by databases.
    It&#39;s probably a symptom of how I got into programming - abusing Excel spreadsheets to do things they were never meant to do.
    Still though, there&#39;s something satisfying about categorising data, querying it, and learning the answers to questions you never thought to ask.
  </p>

  <p>Databases, as a standalone application, are incredible pieces of engineering.
    <em>However</em>, I&#39;ve definitely been frustrated at how hard it is to mesh the database with my application.
    You&#39;ve probably felt it too.
  </p>

  <p>SQL feels like magic, but taking it to production is a delicate balancing act.
    ORMs promise the world, then make your life miserable as soon as you do something unexpected.
    You&#39;ll get it to work eventually, but good luck trying to explain it to anyone else!
  </p>

  <p>We&#39;ve taken a totally different approach, writing a custom Svelte store that binds to Firestore.
    If you&#39;re not interested in how we did it, you can just <a href="https://github.com/stevenwaterman/Lexoral/blob/stage/frontend/editor/src/utils/firestoreWritable.ts">read the code for yourself</a>.
    Otherwise, read on!
  </p>

  <h2>A cloud-native approach</h2>

  <p>Lexoral is <em>cloud-native</em>, which means we like confusing people with buzzwords and complicated architecture diagrams.
    It also means that Lexoral was built <em>around</em> its cloud platform, rather than just taking a finished product and deploying it onto the cloud.
    It means we take advantage of the more modern features, like serverless compute, process orchestration, and <em>Firestore</em>.
  </p>

  <figure><img src="/assets/blog/svelte-firestore-binding/Pipeline.svg" alt="A complex diagram showing the components of Lexoral's transcription pipeline. The details aren't important, just know that it's a tangled mess of arrows between buckets, cloud functions, and workflows.">
    <figcaption>I mean, just look at our transcription pipeline...</figcaption></figure>

  <p>Firestore is a cloud-hosted NoSQL database.
    Let me stress now that it&#39;s <em>not</em> a silver bullet, and it certainly has downsides just like SQL does.
    Querying is harder, and it&#39;s incredibly easy to mess up your database schema - because there isn&#39;t one.
    I&#39;m not here to compare the two though.
    I&#39;m here to show off the cool things you can do by fully embracing Firestore.
  </p>

  <p>Using the Firestore API, you can treat your database as one gigantic JSON object.
    It&#39;s a bit like having the entire database stored in the browser&#39;s memory - letting you read and write the data at any path straight from the client.
    Sounds scary, but Firestore has its own security layer, meaning you can restrict access to parts of the database depending on the user&#39;s authentication status.
    Essentially, you don&#39;t need a backend for <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a>.
    That&#39;s great, but it gets better.
  </p>

  <p>Firestore&#39;s real value comes when you <em>subscribe</em> to a path in the database, getting real-time updates whenever the data changes.
    Those reactive database queries pair <em>really</em> nicely with Svelte&#39;s reactive updates.
    If you haven&#39;t heard of <a href="https://svelte.dev">Svelte</a> before, it&#39;s a frontend framework that selectively re-renders parts of the web page when variables are updated.
    It&#39;s not a runtime library, like React or Vue, instead it traverses the dependency graph between your variables at compile-time and custom-generates code to surgically update the DOM.
    You can probably see how it fits in with Firestore.
  </p>

  <p>Combining the two, our app can display a value from the database, updating the display whenever the value changes.
    Even better, we can use Svelte&#39;s <a href="https://svelte.dev/docs#run-time-svelte-store">store API</a>, creating a data container that keeps <em>itself</em> in sync with the database.
    Then, if we wanted to an up-to-date display of how much credit you have, it would be as simple as:
  </p>

  <figure class="container wide svelte-1o5982m"><h2 class="name svelte-1o5982m">Credit.svelte</h2>

  
  
  <code class="visualCode svelte-12l7s60" aria-hidden="true">

<div class="fromLine same svelte-19djgjm" aria-hidden="true">1</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">1</div>
  <div class="code same svelte-19djgjm">&lt;script lang=<span class="hljs-string">&quot;ts&quot;</span>&gt;</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">2</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">2</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-keyword">import</span> { creditStore } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./credit&quot;</span>;</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">3</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">3</div>
  <div class="code same svelte-19djgjm">&lt;/script&gt;</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">4</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">4</div>
  <div class="code same svelte-19djgjm"> </div><div class="fromLine same svelte-19djgjm" aria-hidden="true">5</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">5</div>
  <div class="code same svelte-19djgjm"><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>Credit: {$creditStore}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span></div></code>

<code class="sr-code svelte-12l7s60">&lt;script lang=<span class="hljs-string">&quot;ts&quot;</span>&gt;
  <span class="hljs-keyword">import</span> { creditStore } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./credit&quot;</span>;
&lt;/script&gt;

<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>Credit: {$creditStore}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span></code></figure>

  <p>In that example, the store is read-only, but Svelte supports read-write stores too.
    Writable stores are especially fancy because you can bind them to an HTML <em>input</em> element.
    Any time the user adjusts the input value, Svelte automatically updates the store for you.
    Since users aren&#39;t allowed to give themselves free credit (sorry), let&#39;s have a look at a volume slider instead:
  </p>

  <figure class="container wide svelte-1o5982m"><h2 class="name svelte-1o5982m">Volume.svelte</h2>

  
  
  <code class="visualCode svelte-12l7s60" aria-hidden="true">

<div class="fromLine same svelte-19djgjm" aria-hidden="true">1</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">1</div>
  <div class="code same svelte-19djgjm">&lt;script lang=<span class="hljs-string">&quot;ts&quot;</span>&gt;</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">2</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">2</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-keyword">import</span> { volumeStore } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./audioSettings&quot;</span>;</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">3</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">3</div>
  <div class="code same svelte-19djgjm">&lt;/script&gt;</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">4</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">4</div>
  <div class="code same svelte-19djgjm"> </div><div class="fromLine same svelte-19djgjm" aria-hidden="true">5</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">5</div>
  <div class="code same svelte-19djgjm"><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;range&quot;</span> <span class="hljs-attr">min</span>=<span class="hljs-string">{0}</span> <span class="hljs-attr">max</span>=<span class="hljs-string">{100}</span> <span class="hljs-attr">step</span>=<span class="hljs-string">{1}</span> <span class="hljs-attr">bind:value</span>=<span class="hljs-string">{$volumeStore}</span> /&gt;</span></span></div></code>

<code class="sr-code svelte-12l7s60">&lt;script lang=<span class="hljs-string">&quot;ts&quot;</span>&gt;
  <span class="hljs-keyword">import</span> { volumeStore } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./audioSettings&quot;</span>;
&lt;/script&gt;

<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;range&quot;</span> <span class="hljs-attr">min</span>=<span class="hljs-string">{0}</span> <span class="hljs-attr">max</span>=<span class="hljs-string">{100}</span> <span class="hljs-attr">step</span>=<span class="hljs-string">{1}</span> <span class="hljs-attr">bind:value</span>=<span class="hljs-string">{$volumeStore}</span> /&gt;</span></span></code></figure>

	<p>With a custom store implementation, that&#39;s all it takes to get a two-way database binding.
    A volume slider that stores your preference in the database, and synchronises across tabs, days, or even devices.
    You can adjust the slider on one tab and watch it move on the other.
    Sounds like magic!
  </p>

  <p>It&#39;s probably obvious by now, but none of this is hypothetical.
    I&#39;ve actually just described exactly how Lexoral handles your volume settings, behind the scenes.
    That hypothetical read-write store is real, and <a href="https://github.com/stevenwaterman/Lexoral/blob/stage/frontend/editor/src/utils/firestoreWritable.ts">we use it in production</a>.
    Here&#39;s how we did it.
  </p>

  <h2>Ruining the magic</h2>

  <p>Our custom store wasn&#39;t some grand vision, it was built up piece-by-piece over time.
    Rather than looking at the finished product and trying to explain it to you, let&#39;s retrace our steps.
    We&#39;ll start with something simple, and add features until we get to today.
  </p>

  <p>It all began as a basic read-only store, like in the credit example from earlier.
    Internally, it had a native writable store, which got updated whenever the database value changed.
    We could have written it all from scratch, but wrapping a native store means we don&#39;t have to re-create all that subscription logic - we just expose the <code>subscribe</code> method from the inner store instead:
  </p>

  <figure class="container wide svelte-1o5982m"><h2 class="name svelte-1o5982m">Read-only store</h2>

  
  
  <code class="visualCode svelte-12l7s60" aria-hidden="true"><details class="svelte-19djgjm"><summary class="svelte-19djgjm">&lt;Show 27 identical lines&gt;</summary>
    <div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">12</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">12</div>
        <div class="code hidden svelte-19djgjm">{</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">13</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">13</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">14</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">14</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-variable language_">document</span>: DocumentReference&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">15</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">15</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">16</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">16</div>
        <div class="code hidden svelte-19djgjm">  </span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">17</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">17</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>, <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">18</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">18</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">19</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">19</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">20</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">20</div>
        <div class="code hidden svelte-19djgjm">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">21</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">21</div>
        <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">22</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">22</div>
        <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">23</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">23</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">24</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">24</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">25</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">25</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">26</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">26</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-property">subscribe</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">27</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">27</div>
        <div class="code hidden svelte-19djgjm">}</div></details>

<div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">12</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">12</div>
  <div class="code hidden svelte-19djgjm">{</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">13</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">13</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">14</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">14</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-variable language_">document</span>: DocumentReference&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">15</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">15</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">16</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">16</div>
  <div class="code hidden svelte-19djgjm">  </span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">17</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">17</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>, <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">18</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">18</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">19</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">19</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">20</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">20</div>
  <div class="code hidden svelte-19djgjm">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">21</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">21</div>
  <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">22</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">22</div>
  <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">23</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">23</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">24</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">24</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">25</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">25</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">26</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">26</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-property">subscribe</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">27</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">27</div>
  <div class="code hidden svelte-19djgjm">}</div></code>

<code class="sr-code svelte-12l7s60"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">DocumentReference</span>,
  onSnapshot,
  <span class="hljs-title class_">PartialWithFieldValue</span>,
  setDoc,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;
<span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;
<span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;
  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;
{
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-variable language_">document</span>: DocumentReference&lt;T&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T
  </span>) {
    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>, <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();
      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });
    });
  }

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-property">subscribe</span>;
}</code></figure>

  <p>It might look a little complicated at first, but there&#39;s really not much to it.
    We created a new class that implements the <code>Readable</code> store inferface.
    In the constructor, it accepts a reference to a Firestore document, similar to a file path.
  </p>

  <p>For Lexoral, that&#39;s usually something like <code>/users/{uid}/settings/audio</code> - meaning Firestore can check the current user&#39;s ID against the ID in the requested document.
    Our store then starts listening for changes to the document, and updating <code>remoteStore</code> when they happen.
    Any calls to <code>subscribe</code> are passed to the internal store, meaning all our subscribers get notified of that update.
  </p>

  <p>That&#39;s already pretty useful, but a writable store would be even nicer.
    Thankfully, it&#39;s not complicated to add a method that updates the database:
  </p>

  <figure class="container wide svelte-1o5982m"><h2 class="name svelte-1o5982m">Read-write store</h2>

  <label class="diffLabel svelte-1o5982m" for="diff-Read-only store-Read-write store-checkbox" title="Tick to show changes from Read-only store to Read-write store">Show Diff</label>
    <input class="diffCheckbox svelte-1o5982m" id="diff-Read-only store-Read-write store-checkbox" type="checkbox" checked autocomplete="off">
  
  <code class="visualCode svelte-12l7s60" aria-hidden="true"><details class="svelte-19djgjm"><summary class="svelte-19djgjm">&lt;Show 23 identical lines&gt;</summary>
    <div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">12</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">12</div>
        <div class="code hidden svelte-19djgjm">{</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">13</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">13</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">14</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">14</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-variable language_">document</span>: DocumentReference&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">15</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">15</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">16</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">16</div>
        <div class="code hidden svelte-19djgjm">  </span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">17</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">17</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>, <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">18</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">18</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">19</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">19</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">20</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">20</div>
        <div class="code hidden svelte-19djgjm">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">21</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">21</div>
        <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">22</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">22</div>
        <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">23</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">23</div>
        <div class="code hidden svelte-19djgjm"> </div></details>

<div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">12</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">12</div>
  <div class="code hidden svelte-19djgjm">{</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">13</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">13</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">14</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">14</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-variable language_">document</span>: DocumentReference&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">15</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">15</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">16</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">16</div>
  <div class="code hidden svelte-19djgjm">  </span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">17</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">17</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>, <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">18</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">18</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">19</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">19</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">20</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">20</div>
  <div class="code hidden svelte-19djgjm">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">21</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">21</div>
  <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">22</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">22</div>
  <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">23</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">23</div>
  <div class="code hidden svelte-19djgjm"> </div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">24</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">24</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">25</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">25</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">26</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">26</div>
  <div class="code same svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-property">subscribe</span>;</div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">27</div>
  <div class="code added svelte-19djgjm"> </div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">28</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">29</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-title function_">setDoc</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>, patch <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>, { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> });</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">30</div>
  <div class="code added svelte-19djgjm">  }</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">27</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">31</div>
  <div class="code same svelte-19djgjm">}</div></code>

<code class="sr-code svelte-12l7s60"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">DocumentReference</span>,
  onSnapshot,
  <span class="hljs-title class_">PartialWithFieldValue</span>,
  setDoc,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;
<span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;
<span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;
  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;
{
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-variable language_">document</span>: DocumentReference&lt;T&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T
  </span>) {
    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>, <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();
      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });
    });
  }

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-property">subscribe</span>;

  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {
    <span class="hljs-title function_">setDoc</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>, patch <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>, { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> });
  }
}</code></figure>

  <p>Those of you familiar with Svelte and its store inferface will notice that this method is called <code>commit</code> rather than <code>set</code>.
    That means it&#39;s <em>not</em> a valid <code>Writable</code> store.
    It seems strange, but it&#39;s a deliberate choice.
  </p>

  <p>The main reason for calling the method <code>commit</code> rather than <code>set</code> is that we have <em>already</em> violated the spec.
    Notice that we enable the <code>merge</code> option when updating the database with <code>setDoc</code>.
    That means that when you call <code>commit</code> with an argument, the new value in the database <em>isn&#39;t</em> the argument you provided.
    Instead, your argument is merged with the existing data, like a patch, or a list of overrides.
  </p>

  <p>Compare that to the <code>Writable</code> interface - which expects the new value to be exactly what you passed in.
    It makes sense to stray from the spec here, because it&#39;s quite rare that you want to replace an entire document in Firestore.
    Much more often, you just want to edit one or two fields.
    This will be important later, but we&#39;ve got more pressing issues right now!
  </p>

  <p>Currently, our store connects to the database as soon as it&#39;s created - but the user might not be authenticated yet.
    We could just accept that, and demand that no stores are created until the user is logged in, but it&#39;s easy to mess up and hard to debug.
    If we get it wrong, Firestore will start throwing errors.
    Users are only allowed to read and write their own data, but without being logged in there&#39;s no way for Firestore to check who&#39;s asking.
  </p>

  <p>Instead, we&#39;ll separate the startup sequence into two steps.
    When the store is created, it won&#39;t connect to Firestore immediately.
    Then, once the user is logged in and Firebase is initialised, we can set up that database connection.
    Any attempts to update the store value before then will be rejected:
  </p>

  <figure class="container wide svelte-1o5982m"><h2 class="name svelte-1o5982m">Late-Connect</h2>

  <label class="diffLabel svelte-1o5982m" for="diff-Read-write store-Late-Connect-checkbox" title="Tick to show changes from Read-write store to Late-Connect">Show Diff</label>
    <input class="diffCheckbox svelte-1o5982m" id="diff-Read-write store-Late-Connect-checkbox" type="checkbox" checked autocomplete="off">
  
  <code class="visualCode svelte-12l7s60" aria-hidden="true"><details class="svelte-19djgjm"><summary class="svelte-19djgjm">&lt;Show 10 identical lines&gt;</summary>
    <div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div></details>

<div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">11</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">11</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">12</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">12</div>
  <div class="code same svelte-19djgjm">{</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">13</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">13</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div>

<div class="fromLine removed svelte-19djgjm" aria-hidden="true">14</div>
  <div class="toLine removed svelte-19djgjm" aria-hidden="true"> </div>
  <div class="code removed svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-variable language_">document</span>: DocumentReference&lt;T&gt;,</div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">14</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">15</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">15</div>
  <div class="code same svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T</div>

<div class="fromLine removed svelte-19djgjm" aria-hidden="true">16</div>
  <div class="toLine removed svelte-19djgjm" aria-hidden="true"> </div>
  <div class="code removed svelte-19djgjm">  </span>) {</div><div class="fromLine removed svelte-19djgjm" aria-hidden="true">17</div>
  <div class="toLine removed svelte-19djgjm" aria-hidden="true"> </div>
  <div class="code removed svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>, <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">16</div>
  <div class="code added svelte-19djgjm">  </span>) {}</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">17</div>
  <div class="code added svelte-19djgjm"> </div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">18</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-keyword">private</span> connected = <span class="hljs-literal">false</span>;</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">19</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">20</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">21</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-property">subscribe</span>;</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">22</div>
  <div class="code added svelte-19djgjm"> </div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">23</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">24</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">25</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">26</div>
  <div class="code added svelte-19djgjm"> </div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">27</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">18</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">28</div>
  <div class="code same svelte-19djgjm">      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">19</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">29</div>
  <div class="code same svelte-19djgjm">      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">20</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">30</div>
  <div class="code same svelte-19djgjm">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">21</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">31</div>
  <div class="code same svelte-19djgjm">    });</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">22</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">32</div>
  <div class="code same svelte-19djgjm">  }</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">23</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">33</div>
  <div class="code same svelte-19djgjm"> </div>

<div class="fromLine removed svelte-19djgjm" aria-hidden="true">24</div>
  <div class="toLine removed svelte-19djgjm" aria-hidden="true"> </div>
  <div class="code removed svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);</div><div class="fromLine removed svelte-19djgjm" aria-hidden="true">25</div>
  <div class="toLine removed svelte-19djgjm" aria-hidden="true"> </div>
  <div class="code removed svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =</div><div class="fromLine removed svelte-19djgjm" aria-hidden="true">26</div>
  <div class="toLine removed svelte-19djgjm" aria-hidden="true"> </div>
  <div class="code removed svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-property">subscribe</span>;</div><div class="fromLine removed svelte-19djgjm" aria-hidden="true">27</div>
  <div class="toLine removed svelte-19djgjm" aria-hidden="true"> </div>
  <div class="code removed svelte-19djgjm"> </div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">28</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">34</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {</div>

<div class="fromLine removed svelte-19djgjm" aria-hidden="true">29</div>
  <div class="toLine removed svelte-19djgjm" aria-hidden="true"> </div>
  <div class="code removed svelte-19djgjm">    <span class="hljs-title function_">setDoc</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>, patch <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>, { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> });</div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">35</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">36</div>
  <div class="code added svelte-19djgjm">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">37</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-title function_">setDoc</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), patch <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>, { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> });</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">30</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">38</div>
  <div class="code same svelte-19djgjm">  }</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">31</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">39</div>
  <div class="code same svelte-19djgjm">}</div></code>

<code class="sr-code svelte-12l7s60"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">DocumentReference</span>,
  onSnapshot,
  <span class="hljs-title class_">PartialWithFieldValue</span>,
  setDoc,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;
<span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;
<span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;
  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;
{
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T
  </span>) {}

  <span class="hljs-keyword">private</span> connected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-property">subscribe</span>;

  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();
      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });
    });
  }

  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);
    <span class="hljs-title function_">setDoc</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), patch <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>, { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> });
  }
}</code></figure>

  <p>Perfect!
    That store now does everything we need it to.
    It&#39;s a two-way binding to Firestore, and it doesn&#39;t even crash on startup!
    The implementation is perfect, and has no issues whatsoever, as long as you ignore the fact that it costs a fortune and the performance is terrible.
    What&#39;s up with that?
  </p>

  <p>With Firestore, it&#39;s vital that you limit the number of database writes.
    Every time you change something, you have to pay.
    Making things worse, Firestore can only handle about one write per second, on a given document.
    Currently, we write to the database every time the store value changes - which could be 10+ times per second.
    It&#39;ll get expensive and slow, fast.
  </p>

  <p>Clearly we need to reduce how often we write to the database.
    We could <em>try</em> asking the users to stop adjusting their volume so fast, but I think we can find a more robust solution!
    There&#39;s no reason why we need to push updates so often, so let&#39;s batch them up and combine all the updates into one:
  </p>

  <figure class="container wide svelte-1o5982m"><h2 class="name svelte-1o5982m">Batch Write</h2>

  <label class="diffLabel svelte-1o5982m" for="diff-Late-Connect-Batch Write-checkbox" title="Tick to show changes from Late-Connect to Batch Write">Show Diff</label>
    <input class="diffCheckbox svelte-1o5982m" id="diff-Late-Connect-Batch Write-checkbox" type="checkbox" checked autocomplete="off">
  
  <code class="visualCode svelte-12l7s60" aria-hidden="true"><details class="svelte-19djgjm"><summary class="svelte-19djgjm">&lt;Show 16 identical lines&gt;</summary>
    <div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">12</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">12</div>
        <div class="code hidden svelte-19djgjm">{</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">13</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">13</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">14</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">14</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">15</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">15</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">16</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">16</div>
        <div class="code hidden svelte-19djgjm">  </span>) {}</div></details>

<div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">12</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">12</div>
  <div class="code hidden svelte-19djgjm">{</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">13</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">13</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">14</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">14</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">15</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">15</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">16</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">16</div>
  <div class="code hidden svelte-19djgjm">  </span>) {}</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">17</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">17</div>
  <div class="code same svelte-19djgjm"> </div><div class="fromLine same svelte-19djgjm" aria-hidden="true">18</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">18</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-keyword">private</span> connected = <span class="hljs-literal">false</span>;</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">19</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">19</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);</div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">20</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">stageStore</span>: <span class="hljs-title class_">Writable</span>&lt;<span class="hljs-title class_">Partial</span>&lt;T&gt;&gt; = <span class="hljs-title function_">writable</span>({});</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">21</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">localStore</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt; = <span class="hljs-title function_">derived</span>(</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">22</div>
  <div class="code added svelte-19djgjm">    [<span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>],</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">23</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-function">(<span class="hljs-params">[remote, stage]</span>) =&gt;</span> ({ ...remote, ...stage })</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">24</div>
  <div class="code added svelte-19djgjm">  );</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">20</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">25</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =</div>

<div class="fromLine removed svelte-19djgjm" aria-hidden="true">21</div>
  <div class="toLine removed svelte-19djgjm" aria-hidden="true"> </div>
  <div class="code removed svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-property">subscribe</span>;</div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">26</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStore</span>.<span class="hljs-property">subscribe</span>;</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">22</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">27</div>
  <div class="code same svelte-19djgjm"> </div><div class="fromLine same svelte-19djgjm" aria-hidden="true">23</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">28</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">24</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">29</div>
  <div class="code same svelte-19djgjm">    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);</div><details class="svelte-19djgjm"><summary class="svelte-19djgjm">&lt;Show 6 identical lines&gt;</summary>
    <div class="fromLine hidden svelte-19djgjm" aria-hidden="true">25</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">30</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">26</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">31</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">27</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">32</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">28</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">33</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">29</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">34</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">30</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">35</div>
        <div class="code hidden svelte-19djgjm">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });</div></details>

<div class="fromLine hidden svelte-19djgjm" aria-hidden="true">25</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">30</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">26</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">31</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">27</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">32</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">28</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">33</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">29</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">34</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">30</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">35</div>
  <div class="code hidden svelte-19djgjm">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">31</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">36</div>
  <div class="code same svelte-19djgjm">    });</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">32</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">37</div>
  <div class="code same svelte-19djgjm">  }</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">33</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">38</div>
  <div class="code same svelte-19djgjm"> </div>

<div class="fromLine removed svelte-19djgjm" aria-hidden="true">34</div>
  <div class="toLine removed svelte-19djgjm" aria-hidden="true"> </div>
  <div class="code removed svelte-19djgjm">  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {</div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">39</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-keyword">async</span> <span class="hljs-title function_">push</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">35</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">40</div>
  <div class="code same svelte-19djgjm">    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">36</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">41</div>
  <div class="code same svelte-19djgjm">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);</div>

<div class="fromLine removed svelte-19djgjm" aria-hidden="true">37</div>
  <div class="toLine removed svelte-19djgjm" aria-hidden="true"> </div>
  <div class="code removed svelte-19djgjm">    <span class="hljs-title function_">setDoc</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), patch <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>, { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> });</div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">42</div>
  <div class="code added svelte-19djgjm"> </div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">43</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">setDoc</span>(</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">44</div>
  <div class="code added svelte-19djgjm">      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(),</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">45</div>
  <div class="code added svelte-19djgjm">      <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PartialWithFieldValue</span>&lt;T&gt;,</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">46</div>
  <div class="code added svelte-19djgjm">      { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> }</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">47</div>
  <div class="code added svelte-19djgjm">    );</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">48</div>
  <div class="code added svelte-19djgjm"> </div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">49</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">set</span>({});</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">38</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">50</div>
  <div class="code same svelte-19djgjm">  }</div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">51</div>
  <div class="code added svelte-19djgjm"> </div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">52</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">53</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ ...state, ...patch }));</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">54</div>
  <div class="code added svelte-19djgjm">  }</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">39</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">55</div>
  <div class="code same svelte-19djgjm">}</div></code>

<code class="sr-code svelte-12l7s60"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">DocumentReference</span>,
  onSnapshot,
  <span class="hljs-title class_">PartialWithFieldValue</span>,
  setDoc,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;
<span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;
<span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;
  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;
{
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T
  </span>) {}

  <span class="hljs-keyword">private</span> connected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">stageStore</span>: <span class="hljs-title class_">Writable</span>&lt;<span class="hljs-title class_">Partial</span>&lt;T&gt;&gt; = <span class="hljs-title function_">writable</span>({});
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">localStore</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt; = <span class="hljs-title function_">derived</span>(
    [<span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>],
    <span class="hljs-function">(<span class="hljs-params">[remote, stage]</span>) =&gt;</span> ({ ...remote, ...stage })
  );
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStore</span>.<span class="hljs-property">subscribe</span>;

  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();
      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">push</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);

    <span class="hljs-keyword">await</span> <span class="hljs-title function_">setDoc</span>(
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(),
      <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PartialWithFieldValue</span>&lt;T&gt;,
      { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> }
    );

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">set</span>({});
  }

  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ ...state, ...patch }));
  }
}</code></figure>

  <p>Rather than immediately sending changes to the database, <code>commit</code> now <em>stores</em> the pending updates until <code>push</code> is called.
    You might be surprised to see that you can <code>commit</code> before setting up a database connection. 
    Since it&#39;s just updating our local state, that check has been moved to <code>push</code> instead.
  </p>

  <p>The internal structure of this store is getting more and more complex, so let me introduce the two new stores.
    The first, <code>stageStore</code>, contains all the updates that have been made locally but not pushed to Firestore yet.
    Meanwhile, any calls to <code>subscribe</code> are passed to <code>localStore</code>, which is derived from the other two.
    It applies the pending updates onto the current database value to create the most up-to-date view possible.
  </p>

  <p>It&#39;s not until <code>push</code> is called that we actually send anything to the database.
    It performs a single database write which combines all the commits together into one, then clears the pending store.
    By grouping the updates and only writing to the database when necessary, we reduce the cost to a fraction of what it was before, and there&#39;s no more performance bottlenecks.
    Since each user is writing to their own document, the only way to write to a document more than once a second is to use two devices simultaneously.
  </p>

  <p>Since <code>localStore</code> is the one you subscribe to, there&#39;s no visible difference between pushing updates immediately and batching them up.
    Either way, your changes are visible immediately on the current tab.
    Calling <code>push</code> just saves them to the database, meaning they are applied to all your devices. 
  </p>

  <p>However, it&#39;s hard to know <em>when</em> to call <code>push</code>.
    If you forget, then you never save that data and it will be lost.
    If you do it too much, you&#39;re wasting money and ruining the performance.
    In general, it&#39;s just not a very ergonomic API.
    What if we automated it?
  </p>

  <figure class="container wide svelte-1o5982m"><h2 class="name svelte-1o5982m">Auto-Push</h2>

  <label class="diffLabel svelte-1o5982m" for="diff-Batch Write-Auto-Push-checkbox" title="Tick to show changes from Batch Write to Auto-Push">Show Diff</label>
    <input class="diffCheckbox svelte-1o5982m" id="diff-Batch Write-Auto-Push-checkbox" type="checkbox" checked autocomplete="off">
  
  <code class="visualCode svelte-12l7s60" aria-hidden="true"><details class="svelte-19djgjm"><summary class="svelte-19djgjm">&lt;Show 11 identical lines&gt;</summary>
    <div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;</div></details>

<div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">12</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">12</div>
  <div class="code same svelte-19djgjm">{</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">13</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">13</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine same svelte-19djgjm" aria-hidden="true">14</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">14</div>
  <div class="code same svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,</div>

<div class="fromLine removed svelte-19djgjm" aria-hidden="true">15</div>
  <div class="toLine removed svelte-19djgjm" aria-hidden="true"> </div>
  <div class="code removed svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T</div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">15</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T,</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">16</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> debounceDelayMs: <span class="hljs-built_in">number</span> = <span class="hljs-number">1000</span></div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">16</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">17</div>
  <div class="code same svelte-19djgjm">  </span>) {}</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">17</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">18</div>
  <div class="code same svelte-19djgjm"> </div><div class="fromLine same svelte-19djgjm" aria-hidden="true">18</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">19</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-keyword">private</span> connected = <span class="hljs-literal">false</span>;</div><details class="svelte-19djgjm"><summary class="svelte-19djgjm">&lt;Show 15 identical lines&gt;</summary>
    <div class="fromLine hidden svelte-19djgjm" aria-hidden="true">19</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">20</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">20</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">21</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">stageStore</span>: <span class="hljs-title class_">Writable</span>&lt;<span class="hljs-title class_">Partial</span>&lt;T&gt;&gt; = <span class="hljs-title function_">writable</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">21</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">22</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">localStore</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt; = <span class="hljs-title function_">derived</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">22</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">23</div>
        <div class="code hidden svelte-19djgjm">    [<span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>],</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">23</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">24</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-function">(<span class="hljs-params">[remote, stage]</span>) =&gt;</span> ({ ...remote, ...stage })</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">24</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">25</div>
        <div class="code hidden svelte-19djgjm">  );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">25</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">26</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">26</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">27</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStore</span>.<span class="hljs-property">subscribe</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">27</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">28</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">28</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">29</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">29</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">30</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">30</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">31</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">31</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">32</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">32</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">33</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">33</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">34</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();</div></details>

<div class="fromLine hidden svelte-19djgjm" aria-hidden="true">19</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">20</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">20</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">21</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">stageStore</span>: <span class="hljs-title class_">Writable</span>&lt;<span class="hljs-title class_">Partial</span>&lt;T&gt;&gt; = <span class="hljs-title function_">writable</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">21</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">22</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">localStore</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt; = <span class="hljs-title function_">derived</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">22</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">23</div>
  <div class="code hidden svelte-19djgjm">    [<span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>],</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">23</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">24</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-function">(<span class="hljs-params">[remote, stage]</span>) =&gt;</span> ({ ...remote, ...stage })</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">24</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">25</div>
  <div class="code hidden svelte-19djgjm">  );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">25</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">26</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">26</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">27</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStore</span>.<span class="hljs-property">subscribe</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">27</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">28</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">28</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">29</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">29</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">30</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">30</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">31</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">31</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">32</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">32</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">33</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">33</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">34</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">34</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">35</div>
  <div class="code same svelte-19djgjm">      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">35</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">36</div>
  <div class="code same svelte-19djgjm">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">36</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">37</div>
  <div class="code same svelte-19djgjm">    });</div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">38</div>
  <div class="code added svelte-19djgjm"> </div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">39</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-keyword">let</span> <span class="hljs-attr">timer</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">40</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">stageState</span>) =&gt;</span> {</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">41</div>
  <div class="code added svelte-19djgjm">      <span class="hljs-keyword">if</span> (timer !== <span class="hljs-literal">undefined</span>) <span class="hljs-built_in">clearTimeout</span>(timer);</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">42</div>
  <div class="code added svelte-19djgjm">      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(stageState).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">43</div>
  <div class="code added svelte-19djgjm">      timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">push</span>(stageState), <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceDelayMs</span>);</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">44</div>
  <div class="code added svelte-19djgjm">    });</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">37</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">45</div>
  <div class="code same svelte-19djgjm">  }</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">38</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">46</div>
  <div class="code same svelte-19djgjm"> </div><div class="fromLine same svelte-19djgjm" aria-hidden="true">39</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">47</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-keyword">async</span> <span class="hljs-title function_">push</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</div><details class="svelte-19djgjm"><summary class="svelte-19djgjm">&lt;Show 16 identical lines&gt;</summary>
    <div class="fromLine hidden svelte-19djgjm" aria-hidden="true">40</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">48</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">41</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">49</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">42</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">50</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">43</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">51</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">setDoc</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">44</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">52</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(),</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">45</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">53</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PartialWithFieldValue</span>&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">46</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">54</div>
        <div class="code hidden svelte-19djgjm">      { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">47</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">55</div>
        <div class="code hidden svelte-19djgjm">    );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">48</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">56</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">49</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">57</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">set</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">50</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">58</div>
        <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">51</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">59</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">52</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">60</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">53</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">61</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ ...state, ...patch }));</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">54</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">62</div>
        <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">55</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">63</div>
        <div class="code hidden svelte-19djgjm">}</div></details>

<div class="fromLine hidden svelte-19djgjm" aria-hidden="true">40</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">48</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">41</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">49</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">42</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">50</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">43</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">51</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">setDoc</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">44</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">52</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(),</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">45</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">53</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PartialWithFieldValue</span>&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">46</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">54</div>
  <div class="code hidden svelte-19djgjm">      { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">47</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">55</div>
  <div class="code hidden svelte-19djgjm">    );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">48</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">56</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">49</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">57</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">set</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">50</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">58</div>
  <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">51</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">59</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">52</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">60</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">53</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">61</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ ...state, ...patch }));</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">54</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">62</div>
  <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">55</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">63</div>
  <div class="code hidden svelte-19djgjm">}</div></code>

<code class="sr-code svelte-12l7s60"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">DocumentReference</span>,
  onSnapshot,
  <span class="hljs-title class_">PartialWithFieldValue</span>,
  setDoc,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;
<span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;
<span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;
  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;
{
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> debounceDelayMs: <span class="hljs-built_in">number</span> = <span class="hljs-number">1000</span>
  </span>) {}

  <span class="hljs-keyword">private</span> connected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">stageStore</span>: <span class="hljs-title class_">Writable</span>&lt;<span class="hljs-title class_">Partial</span>&lt;T&gt;&gt; = <span class="hljs-title function_">writable</span>({});
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">localStore</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt; = <span class="hljs-title function_">derived</span>(
    [<span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>],
    <span class="hljs-function">(<span class="hljs-params">[remote, stage]</span>) =&gt;</span> ({ ...remote, ...stage })
  );
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStore</span>.<span class="hljs-property">subscribe</span>;

  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();
      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });
    });

    <span class="hljs-keyword">let</span> <span class="hljs-attr">timer</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">stageState</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (timer !== <span class="hljs-literal">undefined</span>) <span class="hljs-built_in">clearTimeout</span>(timer);
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(stageState).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
      timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">push</span>(stageState), <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceDelayMs</span>);
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">push</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);

    <span class="hljs-keyword">await</span> <span class="hljs-title function_">setDoc</span>(
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(),
      <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PartialWithFieldValue</span>&lt;T&gt;,
      { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> }
    );

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">set</span>({});
  }

  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ ...state, ...patch }));
  }
}</code></figure>

  <p>Now our changes are batched up and automatically pushed to Firestore after a period of inactivity.
    Any time we commit something, a timer is started - lasting one second by default.
    If we commit something else before then, the timer resets.
    If not, then we push the changes when the timer runs out.
  </p>

  <p>One second might not seem like very long, but you have to remember the end goal.
    We want to bind this store to a slider, which can cause 60 commits per second when you&#39;re adjusting it.
    However, you&#39;re unlikely to pause for more than a second when adjusting the volume.
    One second is a nice middle ground that ensures it rarely pushes until you&#39;re done, while still having a minimal delay.
  </p>

  <p>It&#39;s also adjustable - when creating the store, you can choose a higher or lower delay based on your use case.
    There&#39;s not much risk in setting it a bit high - pending updates are still applied to your local window instantly.
    A ten-second debounce timer would just mean a ten-second delay before your volume synchronises across devices.
  </p>

  <p>We&#39;ve talked a lot about binding this store to a volume slider, but how would that work?
    It&#39;s not a valid <code>Writable</code>, and it&#39;s not even storing a numeric value!
    Our store represents an entire Firestore document, meaning a JSON object - not exactly something you could update with a slider.
  </p>

  <p>To solve that, let&#39;s add a way to get a <code>Writable</code> stores bound to a specific <em>field</em> on the document.
    In other words, take our <code>audio settings</code> store and create a <code>volume</code> store for its volume field.
    For now, it&#39;s read-only:
  </p>

  <figure class="container wide svelte-1o5982m"><h2 class="name svelte-1o5982m">One-Field Readable Store</h2>

  <label class="diffLabel svelte-1o5982m" for="diff-Auto-Push-One-Field Readable Store-checkbox" title="Tick to show changes from Auto-Push to One-Field Readable Store">Show Diff</label>
    <input class="diffCheckbox svelte-1o5982m" id="diff-Auto-Push-One-Field Readable Store-checkbox" type="checkbox" checked autocomplete="off">
  
  <code class="visualCode svelte-12l7s60" aria-hidden="true"><details class="svelte-19djgjm"><summary class="svelte-19djgjm">&lt;Show 59 identical lines&gt;</summary>
    <div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">12</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">12</div>
        <div class="code hidden svelte-19djgjm">{</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">13</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">13</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">14</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">14</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">15</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">15</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">16</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">16</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> debounceDelayMs: <span class="hljs-built_in">number</span> = <span class="hljs-number">1000</span></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">17</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">17</div>
        <div class="code hidden svelte-19djgjm">  </span>) {}</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">18</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">18</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">19</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">19</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> connected = <span class="hljs-literal">false</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">20</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">20</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">21</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">21</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">stageStore</span>: <span class="hljs-title class_">Writable</span>&lt;<span class="hljs-title class_">Partial</span>&lt;T&gt;&gt; = <span class="hljs-title function_">writable</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">22</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">22</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">localStore</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt; = <span class="hljs-title function_">derived</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">23</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">23</div>
        <div class="code hidden svelte-19djgjm">    [<span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>],</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">24</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">24</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-function">(<span class="hljs-params">[remote, stage]</span>) =&gt;</span> ({ ...remote, ...stage })</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">25</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">25</div>
        <div class="code hidden svelte-19djgjm">  );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">26</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">26</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">27</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">27</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStore</span>.<span class="hljs-property">subscribe</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">28</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">28</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">29</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">29</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">30</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">30</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">31</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">31</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">32</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">32</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">33</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">33</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">34</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">34</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">35</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">35</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">36</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">36</div>
        <div class="code hidden svelte-19djgjm">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">37</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">37</div>
        <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">38</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">38</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">39</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">39</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">let</span> <span class="hljs-attr">timer</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">40</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">40</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">stageState</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">41</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">41</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (timer !== <span class="hljs-literal">undefined</span>) <span class="hljs-built_in">clearTimeout</span>(timer);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">42</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">42</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(stageState).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">43</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">43</div>
        <div class="code hidden svelte-19djgjm">      timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">push</span>(stageState), <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceDelayMs</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">44</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">44</div>
        <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">45</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">45</div>
        <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">46</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">46</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">47</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">47</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">async</span> <span class="hljs-title function_">push</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">48</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">48</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">49</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">49</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">50</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">50</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">51</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">51</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">setDoc</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">52</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">52</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(),</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">53</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">53</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PartialWithFieldValue</span>&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">54</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">54</div>
        <div class="code hidden svelte-19djgjm">      { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">55</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">55</div>
        <div class="code hidden svelte-19djgjm">    );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">56</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">56</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">57</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">57</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">set</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">58</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">58</div>
        <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">59</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">59</div>
        <div class="code hidden svelte-19djgjm"> </div></details>

<div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">12</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">12</div>
  <div class="code hidden svelte-19djgjm">{</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">13</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">13</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">14</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">14</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">15</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">15</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">16</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">16</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> debounceDelayMs: <span class="hljs-built_in">number</span> = <span class="hljs-number">1000</span></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">17</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">17</div>
  <div class="code hidden svelte-19djgjm">  </span>) {}</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">18</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">18</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">19</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">19</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> connected = <span class="hljs-literal">false</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">20</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">20</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">21</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">21</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">stageStore</span>: <span class="hljs-title class_">Writable</span>&lt;<span class="hljs-title class_">Partial</span>&lt;T&gt;&gt; = <span class="hljs-title function_">writable</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">22</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">22</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">localStore</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt; = <span class="hljs-title function_">derived</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">23</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">23</div>
  <div class="code hidden svelte-19djgjm">    [<span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>],</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">24</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">24</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-function">(<span class="hljs-params">[remote, stage]</span>) =&gt;</span> ({ ...remote, ...stage })</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">25</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">25</div>
  <div class="code hidden svelte-19djgjm">  );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">26</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">26</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">27</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">27</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStore</span>.<span class="hljs-property">subscribe</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">28</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">28</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">29</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">29</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">30</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">30</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">31</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">31</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">32</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">32</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">33</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">33</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">34</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">34</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">35</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">35</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">36</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">36</div>
  <div class="code hidden svelte-19djgjm">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">37</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">37</div>
  <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">38</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">38</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">39</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">39</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">let</span> <span class="hljs-attr">timer</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">40</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">40</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">stageState</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">41</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">41</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (timer !== <span class="hljs-literal">undefined</span>) <span class="hljs-built_in">clearTimeout</span>(timer);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">42</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">42</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(stageState).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">43</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">43</div>
  <div class="code hidden svelte-19djgjm">      timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">push</span>(stageState), <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceDelayMs</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">44</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">44</div>
  <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">45</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">45</div>
  <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">46</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">46</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">47</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">47</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">async</span> <span class="hljs-title function_">push</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">48</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">48</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">49</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">49</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">50</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">50</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">51</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">51</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">setDoc</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">52</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">52</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(),</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">53</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">53</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PartialWithFieldValue</span>&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">54</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">54</div>
  <div class="code hidden svelte-19djgjm">      { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">55</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">55</div>
  <div class="code hidden svelte-19djgjm">    );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">56</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">56</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">57</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">57</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">set</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">58</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">58</div>
  <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">59</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">59</div>
  <div class="code hidden svelte-19djgjm"> </div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">60</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">60</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">61</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">61</div>
  <div class="code same svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ ...state, ...patch }));</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">62</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">62</div>
  <div class="code same svelte-19djgjm">  }</div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">63</div>
  <div class="code added svelte-19djgjm"> </div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">64</div>
  <div class="code added svelte-19djgjm">  getField&lt;K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">key</span>: K): <span class="hljs-title class_">FirestoreWritableField</span>&lt;T, K&gt; {</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">65</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FirestoreWritableField</span>(<span class="hljs-variable language_">this</span>, key);</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">66</div>
  <div class="code added svelte-19djgjm">  }</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">67</div>
  <div class="code added svelte-19djgjm">}</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">68</div>
  <div class="code added svelte-19djgjm"> </div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">69</div>
  <div class="code added svelte-19djgjm"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritableField</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;, K <span class="hljs-keyword">extends</span> keyof T&gt;</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">70</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T[K]&gt;</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">71</div>
  <div class="code added svelte-19djgjm">{</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">72</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">73</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> parent: FirestoreWritable&lt;T&gt;,</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">74</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> key: K</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">75</div>
  <div class="code added svelte-19djgjm">  </span>) {}</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">76</div>
  <div class="code added svelte-19djgjm"> </div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">77</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">derivedStore</span>: <span class="hljs-title class_">Readable</span>&lt;T[K]&gt; = <span class="hljs-title function_">derived</span>(</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">78</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>,</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">79</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-function">(<span class="hljs-params">parentValue</span>) =&gt;</span> parentValue[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>]</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">80</div>
  <div class="code added svelte-19djgjm">  );</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">81</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> subscribe = <span class="hljs-variable language_">this</span>.<span class="hljs-property">derivedStore</span>.<span class="hljs-property">subscribe</span>;</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">63</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">82</div>
  <div class="code same svelte-19djgjm">}</div></code>

<code class="sr-code svelte-12l7s60"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">DocumentReference</span>,
  onSnapshot,
  <span class="hljs-title class_">PartialWithFieldValue</span>,
  setDoc,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;
<span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;
<span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;
  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;
{
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> debounceDelayMs: <span class="hljs-built_in">number</span> = <span class="hljs-number">1000</span>
  </span>) {}

  <span class="hljs-keyword">private</span> connected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">stageStore</span>: <span class="hljs-title class_">Writable</span>&lt;<span class="hljs-title class_">Partial</span>&lt;T&gt;&gt; = <span class="hljs-title function_">writable</span>({});
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">localStore</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt; = <span class="hljs-title function_">derived</span>(
    [<span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>],
    <span class="hljs-function">(<span class="hljs-params">[remote, stage]</span>) =&gt;</span> ({ ...remote, ...stage })
  );
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStore</span>.<span class="hljs-property">subscribe</span>;

  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();
      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });
    });

    <span class="hljs-keyword">let</span> <span class="hljs-attr">timer</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">stageState</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (timer !== <span class="hljs-literal">undefined</span>) <span class="hljs-built_in">clearTimeout</span>(timer);
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(stageState).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
      timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">push</span>(stageState), <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceDelayMs</span>);
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">push</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);

    <span class="hljs-keyword">await</span> <span class="hljs-title function_">setDoc</span>(
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(),
      <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PartialWithFieldValue</span>&lt;T&gt;,
      { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> }
    );

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">set</span>({});
  }

  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ ...state, ...patch }));
  }

  getField&lt;K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">key</span>: K): <span class="hljs-title class_">FirestoreWritableField</span>&lt;T, K&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FirestoreWritableField</span>(<span class="hljs-variable language_">this</span>, key);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritableField</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;, K <span class="hljs-keyword">extends</span> keyof T&gt;
  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T[K]&gt;
{
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> parent: FirestoreWritable&lt;T&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> key: K
  </span>) {}

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">derivedStore</span>: <span class="hljs-title class_">Readable</span>&lt;T[K]&gt; = <span class="hljs-title function_">derived</span>(
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>,
    <span class="hljs-function">(<span class="hljs-params">parentValue</span>) =&gt;</span> parentValue[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>]
  );
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> subscribe = <span class="hljs-variable language_">this</span>.<span class="hljs-property">derivedStore</span>.<span class="hljs-property">subscribe</span>;
}</code></figure>

  <p>We&#39;ve added a new Svelte store implementation, <code>FirestoreWritableField</code>.
    As the name suggests, it binds to a specific field on the Firestore document.
    It&#39;s not meant to be created directly by the user - instead we&#39;ve added <code>getField</code> onto the original store.
  </p>

  <p>The child store is implemented using a <code>derived</code> store, which simply extracts the required field from the value of the parent store.
    Any time the parent store updates, we check to see if our field has changed, and if so, notify our subscribers.
    Despite the name of the class, it&#39;s not actually writable yet, so let&#39;s make it a valid Svelte <code>Writable</code> by adding <code>set</code> and <code>update</code>:
  </p>

  <figure class="container wide svelte-1o5982m"><h2 class="name svelte-1o5982m">One-Field Writable Store</h2>

  <label class="diffLabel svelte-1o5982m" for="diff-One-Field Readable Store-One-Field Writable Store-checkbox" title="Tick to show changes from One-Field Readable Store to One-Field Writable Store">Show Diff</label>
    <input class="diffCheckbox svelte-1o5982m" id="diff-One-Field Readable Store-One-Field Writable Store-checkbox" type="checkbox" checked autocomplete="off">
  
  <code class="visualCode svelte-12l7s60" aria-hidden="true"><details class="svelte-19djgjm"><summary class="svelte-19djgjm">&lt;Show 66 identical lines&gt;</summary>
    <div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">12</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">12</div>
        <div class="code hidden svelte-19djgjm">{</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">13</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">13</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">14</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">14</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">15</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">15</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">16</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">16</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> debounceDelayMs: <span class="hljs-built_in">number</span> = <span class="hljs-number">1000</span></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">17</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">17</div>
        <div class="code hidden svelte-19djgjm">  </span>) {}</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">18</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">18</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">19</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">19</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> connected = <span class="hljs-literal">false</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">20</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">20</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">21</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">21</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">stageStore</span>: <span class="hljs-title class_">Writable</span>&lt;<span class="hljs-title class_">Partial</span>&lt;T&gt;&gt; = <span class="hljs-title function_">writable</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">22</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">22</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">localStore</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt; = <span class="hljs-title function_">derived</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">23</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">23</div>
        <div class="code hidden svelte-19djgjm">    [<span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>],</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">24</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">24</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-function">(<span class="hljs-params">[remote, stage]</span>) =&gt;</span> ({ ...remote, ...stage })</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">25</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">25</div>
        <div class="code hidden svelte-19djgjm">  );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">26</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">26</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">27</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">27</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStore</span>.<span class="hljs-property">subscribe</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">28</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">28</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">29</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">29</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">30</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">30</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">31</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">31</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">32</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">32</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">33</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">33</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">34</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">34</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">35</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">35</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">36</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">36</div>
        <div class="code hidden svelte-19djgjm">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">37</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">37</div>
        <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">38</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">38</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">39</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">39</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">let</span> <span class="hljs-attr">timer</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">40</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">40</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">stageState</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">41</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">41</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (timer !== <span class="hljs-literal">undefined</span>) <span class="hljs-built_in">clearTimeout</span>(timer);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">42</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">42</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(stageState).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">43</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">43</div>
        <div class="code hidden svelte-19djgjm">      timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">push</span>(stageState), <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceDelayMs</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">44</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">44</div>
        <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">45</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">45</div>
        <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">46</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">46</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">47</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">47</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">async</span> <span class="hljs-title function_">push</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">48</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">48</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">49</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">49</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">50</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">50</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">51</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">51</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">setDoc</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">52</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">52</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(),</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">53</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">53</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PartialWithFieldValue</span>&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">54</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">54</div>
        <div class="code hidden svelte-19djgjm">      { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">55</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">55</div>
        <div class="code hidden svelte-19djgjm">    );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">56</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">56</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">57</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">57</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">set</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">58</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">58</div>
        <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">59</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">59</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">60</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">60</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">61</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">61</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ ...state, ...patch }));</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">62</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">62</div>
        <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">63</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">63</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">64</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">64</div>
        <div class="code hidden svelte-19djgjm">  getField&lt;K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">key</span>: K): <span class="hljs-title class_">FirestoreWritableField</span>&lt;T, K&gt; {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">65</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">65</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FirestoreWritableField</span>(<span class="hljs-variable language_">this</span>, key);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">66</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">66</div>
        <div class="code hidden svelte-19djgjm">  }</div></details>

<div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">12</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">12</div>
  <div class="code hidden svelte-19djgjm">{</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">13</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">13</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">14</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">14</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">15</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">15</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">16</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">16</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> debounceDelayMs: <span class="hljs-built_in">number</span> = <span class="hljs-number">1000</span></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">17</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">17</div>
  <div class="code hidden svelte-19djgjm">  </span>) {}</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">18</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">18</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">19</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">19</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> connected = <span class="hljs-literal">false</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">20</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">20</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">21</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">21</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">stageStore</span>: <span class="hljs-title class_">Writable</span>&lt;<span class="hljs-title class_">Partial</span>&lt;T&gt;&gt; = <span class="hljs-title function_">writable</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">22</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">22</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">localStore</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt; = <span class="hljs-title function_">derived</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">23</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">23</div>
  <div class="code hidden svelte-19djgjm">    [<span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>],</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">24</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">24</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-function">(<span class="hljs-params">[remote, stage]</span>) =&gt;</span> ({ ...remote, ...stage })</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">25</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">25</div>
  <div class="code hidden svelte-19djgjm">  );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">26</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">26</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">27</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">27</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStore</span>.<span class="hljs-property">subscribe</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">28</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">28</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">29</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">29</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">30</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">30</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">31</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">31</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">32</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">32</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">33</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">33</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">34</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">34</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">35</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">35</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">36</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">36</div>
  <div class="code hidden svelte-19djgjm">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">37</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">37</div>
  <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">38</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">38</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">39</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">39</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">let</span> <span class="hljs-attr">timer</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">40</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">40</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">stageState</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">41</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">41</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (timer !== <span class="hljs-literal">undefined</span>) <span class="hljs-built_in">clearTimeout</span>(timer);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">42</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">42</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(stageState).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">43</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">43</div>
  <div class="code hidden svelte-19djgjm">      timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">push</span>(stageState), <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceDelayMs</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">44</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">44</div>
  <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">45</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">45</div>
  <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">46</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">46</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">47</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">47</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">async</span> <span class="hljs-title function_">push</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">48</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">48</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">49</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">49</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">50</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">50</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">51</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">51</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">setDoc</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">52</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">52</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(),</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">53</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">53</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PartialWithFieldValue</span>&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">54</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">54</div>
  <div class="code hidden svelte-19djgjm">      { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">55</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">55</div>
  <div class="code hidden svelte-19djgjm">    );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">56</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">56</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">57</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">57</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">set</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">58</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">58</div>
  <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">59</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">59</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">60</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">60</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">61</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">61</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ ...state, ...patch }));</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">62</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">62</div>
  <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">63</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">63</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">64</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">64</div>
  <div class="code hidden svelte-19djgjm">  getField&lt;K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">key</span>: K): <span class="hljs-title class_">FirestoreWritableField</span>&lt;T, K&gt; {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">65</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">65</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FirestoreWritableField</span>(<span class="hljs-variable language_">this</span>, key);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">66</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">66</div>
  <div class="code hidden svelte-19djgjm">  }</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">67</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">67</div>
  <div class="code same svelte-19djgjm">}</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">68</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">68</div>
  <div class="code same svelte-19djgjm"> </div><div class="fromLine same svelte-19djgjm" aria-hidden="true">69</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">69</div>
  <div class="code same svelte-19djgjm"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritableField</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;, K <span class="hljs-keyword">extends</span> keyof T&gt;</div>

<div class="fromLine removed svelte-19djgjm" aria-hidden="true">70</div>
  <div class="toLine removed svelte-19djgjm" aria-hidden="true"> </div>
  <div class="code removed svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T[K]&gt;</div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">70</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Writable</span>&lt;T[K]&gt;</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">71</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">71</div>
  <div class="code same svelte-19djgjm">{</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">72</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">72</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine same svelte-19djgjm" aria-hidden="true">73</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">73</div>
  <div class="code same svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> parent: FirestoreWritable&lt;T&gt;,</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">74</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">74</div>
  <div class="code same svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> key: K</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">75</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">75</div>
  <div class="code same svelte-19djgjm">  </span>) {}</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">76</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">76</div>
  <div class="code same svelte-19djgjm"> </div><div class="fromLine same svelte-19djgjm" aria-hidden="true">77</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">77</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">derivedStore</span>: <span class="hljs-title class_">Readable</span>&lt;T[K]&gt; = <span class="hljs-title function_">derived</span>(</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">78</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">78</div>
  <div class="code same svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>,</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">79</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">79</div>
  <div class="code same svelte-19djgjm">    <span class="hljs-function">(<span class="hljs-params">parentValue</span>) =&gt;</span> parentValue[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>]</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">80</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">80</div>
  <div class="code same svelte-19djgjm">  );</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">81</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">81</div>
  <div class="code same svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> subscribe = <span class="hljs-variable language_">this</span>.<span class="hljs-property">derivedStore</span>.<span class="hljs-property">subscribe</span>;</div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">82</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> push = <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>.<span class="hljs-property">push</span>;</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">83</div>
  <div class="code added svelte-19djgjm"> </div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">84</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-title function_">set</span>(<span class="hljs-params">value: T[K]</span>) {</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">85</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-keyword">const</span> <span class="hljs-attr">patch</span>: <span class="hljs-title class_">Partial</span>&lt;T&gt; = {};</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">86</div>
  <div class="code added svelte-19djgjm">    patch[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>] = value;</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">87</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>.<span class="hljs-title function_">commit</span>(patch);</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">88</div>
  <div class="code added svelte-19djgjm">  }</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">89</div>
  <div class="code added svelte-19djgjm"> </div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">90</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-title function_">update</span>(<span class="hljs-params">updater: (value: T[K]) =&gt; T[K]</span>) {</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">91</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-keyword">const</span> oldValue = <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">derivedStore</span>);</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">92</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">set</span>(<span class="hljs-title function_">updater</span>(oldValue));</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">93</div>
  <div class="code added svelte-19djgjm">  }</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">82</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">94</div>
  <div class="code same svelte-19djgjm">}</div></code>

<code class="sr-code svelte-12l7s60"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">DocumentReference</span>,
  onSnapshot,
  <span class="hljs-title class_">PartialWithFieldValue</span>,
  setDoc,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;
<span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;
<span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;
  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;
{
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> debounceDelayMs: <span class="hljs-built_in">number</span> = <span class="hljs-number">1000</span>
  </span>) {}

  <span class="hljs-keyword">private</span> connected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">stageStore</span>: <span class="hljs-title class_">Writable</span>&lt;<span class="hljs-title class_">Partial</span>&lt;T&gt;&gt; = <span class="hljs-title function_">writable</span>({});
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">localStore</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt; = <span class="hljs-title function_">derived</span>(
    [<span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>],
    <span class="hljs-function">(<span class="hljs-params">[remote, stage]</span>) =&gt;</span> ({ ...remote, ...stage })
  );
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStore</span>.<span class="hljs-property">subscribe</span>;

  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();
      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });
    });

    <span class="hljs-keyword">let</span> <span class="hljs-attr">timer</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">stageState</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (timer !== <span class="hljs-literal">undefined</span>) <span class="hljs-built_in">clearTimeout</span>(timer);
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(stageState).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
      timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">push</span>(stageState), <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceDelayMs</span>);
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">push</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);

    <span class="hljs-keyword">await</span> <span class="hljs-title function_">setDoc</span>(
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(),
      <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PartialWithFieldValue</span>&lt;T&gt;,
      { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> }
    );

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">set</span>({});
  }

  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ ...state, ...patch }));
  }

  getField&lt;K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">key</span>: K): <span class="hljs-title class_">FirestoreWritableField</span>&lt;T, K&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FirestoreWritableField</span>(<span class="hljs-variable language_">this</span>, key);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritableField</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;, K <span class="hljs-keyword">extends</span> keyof T&gt;
  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Writable</span>&lt;T[K]&gt;
{
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> parent: FirestoreWritable&lt;T&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> key: K
  </span>) {}

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">derivedStore</span>: <span class="hljs-title class_">Readable</span>&lt;T[K]&gt; = <span class="hljs-title function_">derived</span>(
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>,
    <span class="hljs-function">(<span class="hljs-params">parentValue</span>) =&gt;</span> parentValue[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>]
  );
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> subscribe = <span class="hljs-variable language_">this</span>.<span class="hljs-property">derivedStore</span>.<span class="hljs-property">subscribe</span>;
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> push = <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>.<span class="hljs-property">push</span>;

  <span class="hljs-title function_">set</span>(<span class="hljs-params">value: T[K]</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">patch</span>: <span class="hljs-title class_">Partial</span>&lt;T&gt; = {};
    patch[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>] = value;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>.<span class="hljs-title function_">commit</span>(patch);
  }

  <span class="hljs-title function_">update</span>(<span class="hljs-params">updater: (value: T[K]) =&gt; T[K]</span>) {
    <span class="hljs-keyword">const</span> oldValue = <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">derivedStore</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">set</span>(<span class="hljs-title function_">updater</span>(oldValue));
  }
}</code></figure>

  <p>There&#39;s no need to worry about Firestore when writing these methods - we simply propagate the calls up to the parent and set the value for our field.
    That&#39;s why it was so important for us to be able to apply a partial patch to the parent store - it allows these single-field stores to be standalone.
  </p>

  <p>That store implementation is looking pretty good now!
    It&#39;s got everything we need to actually use it in an application, so let&#39;s try it out:
  </p>

  <figure class="container wide svelte-1o5982m"><h2 class="name svelte-1o5982m">audio.ts</h2>

  
  
  <code class="visualCode svelte-12l7s60" aria-hidden="true"><details class="svelte-19djgjm"><summary class="svelte-19djgjm">&lt;Show 13 identical lines&gt;</summary>
    <div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { doc, <span class="hljs-title class_">DocumentReference</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">FirestoreWritable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./utils/firestoreWritable&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">const</span> initial = {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-attr">loop</span>: <span class="hljs-literal">false</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-attr">volume</span>: <span class="hljs-number">100</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-attr">rate</span>: <span class="hljs-number">100</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="code hidden svelte-19djgjm">};</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> audioSettings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FirestoreWritable</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">doc</span>(firestore, userId, <span class="hljs-string">&quot;settings&quot;</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">DocumentReference</span>&lt;<span class="hljs-keyword">typeof</span> initial&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">12</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">12</div>
        <div class="code hidden svelte-19djgjm">  initial</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">13</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">13</div>
        <div class="code hidden svelte-19djgjm">);</div></details>

<div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { doc, <span class="hljs-title class_">DocumentReference</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">FirestoreWritable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./utils/firestoreWritable&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">const</span> initial = {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-attr">loop</span>: <span class="hljs-literal">false</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-attr">volume</span>: <span class="hljs-number">100</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-attr">rate</span>: <span class="hljs-number">100</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="code hidden svelte-19djgjm">};</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> audioSettings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FirestoreWritable</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">doc</span>(firestore, userId, <span class="hljs-string">&quot;settings&quot;</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">DocumentReference</span>&lt;<span class="hljs-keyword">typeof</span> initial&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">12</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">12</div>
  <div class="code hidden svelte-19djgjm">  initial</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">13</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">13</div>
  <div class="code hidden svelte-19djgjm">);</div></code>

<code class="sr-code svelte-12l7s60"><span class="hljs-keyword">import</span> { doc, <span class="hljs-title class_">DocumentReference</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FirestoreWritable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./utils/firestoreWritable&quot;</span>;

<span class="hljs-keyword">const</span> initial = {
  <span class="hljs-attr">loop</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">volume</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attr">rate</span>: <span class="hljs-number">100</span>,
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> audioSettings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FirestoreWritable</span>(
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">doc</span>(firestore, userId, <span class="hljs-string">&quot;settings&quot;</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">DocumentReference</span>&lt;<span class="hljs-keyword">typeof</span> initial&gt;,
  initial
);</code></figure>
	<figure class="container wide svelte-1o5982m"><h2 class="name svelte-1o5982m">Volume.svelte</h2>

  
  
  <code class="visualCode svelte-12l7s60" aria-hidden="true"><details class="svelte-19djgjm"><summary class="svelte-19djgjm">&lt;Show 6 identical lines&gt;</summary>
    <div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="code hidden svelte-19djgjm">&lt;script lang=<span class="hljs-string">&quot;ts&quot;</span>&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">import</span> { audioSettings } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./example&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-attr">$</span>: volumeStore = audioSettings.<span class="hljs-title function_">getField</span>(<span class="hljs-string">&quot;volume&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="code hidden svelte-19djgjm">&lt;/script&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="code hidden svelte-19djgjm"><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;range&quot;</span> <span class="hljs-attr">min</span>=<span class="hljs-string">{0}</span> <span class="hljs-attr">max</span>=<span class="hljs-string">{100}</span> <span class="hljs-attr">step</span>=<span class="hljs-string">{1}</span> <span class="hljs-attr">bind:value</span>=<span class="hljs-string">{$volumeStore}</span> /&gt;</span></span></div></details>

<div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="code hidden svelte-19djgjm">&lt;script lang=<span class="hljs-string">&quot;ts&quot;</span>&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">import</span> { audioSettings } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./example&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-attr">$</span>: volumeStore = audioSettings.<span class="hljs-title function_">getField</span>(<span class="hljs-string">&quot;volume&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="code hidden svelte-19djgjm">&lt;/script&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="code hidden svelte-19djgjm"><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;range&quot;</span> <span class="hljs-attr">min</span>=<span class="hljs-string">{0}</span> <span class="hljs-attr">max</span>=<span class="hljs-string">{100}</span> <span class="hljs-attr">step</span>=<span class="hljs-string">{1}</span> <span class="hljs-attr">bind:value</span>=<span class="hljs-string">{$volumeStore}</span> /&gt;</span></span></div></code>

<code class="sr-code svelte-12l7s60">&lt;script lang=<span class="hljs-string">&quot;ts&quot;</span>&gt;
  <span class="hljs-keyword">import</span> { audioSettings } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./example&quot;</span>;
  <span class="hljs-attr">$</span>: volumeStore = audioSettings.<span class="hljs-title function_">getField</span>(<span class="hljs-string">&quot;volume&quot;</span>);
&lt;/script&gt;

<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;range&quot;</span> <span class="hljs-attr">min</span>=<span class="hljs-string">{0}</span> <span class="hljs-attr">max</span>=<span class="hljs-string">{100}</span> <span class="hljs-attr">step</span>=<span class="hljs-string">{1}</span> <span class="hljs-attr">bind:value</span>=<span class="hljs-string">{$volumeStore}</span> /&gt;</span></span></code></figure>

  <p>In <code>audio.ts</code>, we create a new store, binding it to the document at a specific path in Firestore.
    We set the initial values for the document, which get used if the document doesn&#39;t exist or we haven&#39;t called <code>connect</code> yet.
    The call to <code>connect</code> isn&#39;t shown in this example, since it would normally be in a post-authentication callback.
  </p>

  <p>Then, in <code>Volume.svelte</code>, we extract the <code>volume</code> field from the document into its own store.
    We create a slider element, and bind its value to the volume store.
    That&#39;s all it takes to get a two-way database binding.
  </p>

  <p>Whenever the volume field updates on the Firestore document, the volume slider will jump to its new position.
    Whenever the slider is adjusted, then after one second of no further changes it will push its new value to Firestore!
  </p>

  <p>There is still one issue with our current implementation - it&#39;s quite wasteful.
    Every time we call <code>getField</code>, it creates a new store, even though all the stores for a given field are identical.
    We can solve that by adding a cache:
  </p>

  <figure class="container wide svelte-1o5982m"><h2 class="name svelte-1o5982m">Cached Field Stores</h2>

  <label class="diffLabel svelte-1o5982m" for="diff-One-Field Writable Store-Cached Field Stores-checkbox" title="Tick to show changes from One-Field Writable Store to Cached Field Stores">Show Diff</label>
    <input class="diffCheckbox svelte-1o5982m" id="diff-One-Field Writable Store-Cached Field Stores-checkbox" type="checkbox" checked autocomplete="off">
  
  <code class="visualCode svelte-12l7s60" aria-hidden="true"><details class="svelte-19djgjm"><summary class="svelte-19djgjm">&lt;Show 60 identical lines&gt;</summary>
    <div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
        <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
        <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
        <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">12</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">12</div>
        <div class="code hidden svelte-19djgjm">{</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">13</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">13</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">14</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">14</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">15</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">15</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">16</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">16</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> debounceDelayMs: <span class="hljs-built_in">number</span> = <span class="hljs-number">1000</span></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">17</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">17</div>
        <div class="code hidden svelte-19djgjm">  </span>) {}</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">18</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">18</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">19</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">19</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> connected = <span class="hljs-literal">false</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">20</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">20</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">21</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">21</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">stageStore</span>: <span class="hljs-title class_">Writable</span>&lt;<span class="hljs-title class_">Partial</span>&lt;T&gt;&gt; = <span class="hljs-title function_">writable</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">22</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">22</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">localStore</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt; = <span class="hljs-title function_">derived</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">23</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">23</div>
        <div class="code hidden svelte-19djgjm">    [<span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>],</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">24</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">24</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-function">(<span class="hljs-params">[remote, stage]</span>) =&gt;</span> ({ ...remote, ...stage })</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">25</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">25</div>
        <div class="code hidden svelte-19djgjm">  );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">26</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">26</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">27</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">27</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStore</span>.<span class="hljs-property">subscribe</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">28</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">28</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">29</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">29</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">30</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">30</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">31</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">31</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">32</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">32</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">33</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">33</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">34</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">34</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">35</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">35</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">36</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">36</div>
        <div class="code hidden svelte-19djgjm">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">37</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">37</div>
        <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">38</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">38</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">39</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">39</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">let</span> <span class="hljs-attr">timer</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">40</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">40</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">stageState</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">41</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">41</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (timer !== <span class="hljs-literal">undefined</span>) <span class="hljs-built_in">clearTimeout</span>(timer);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">42</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">42</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(stageState).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">43</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">43</div>
        <div class="code hidden svelte-19djgjm">      timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">push</span>(stageState), <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceDelayMs</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">44</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">44</div>
        <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">45</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">45</div>
        <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">46</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">46</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">47</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">47</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">async</span> <span class="hljs-title function_">push</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">48</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">48</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">49</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">49</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">50</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">50</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">51</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">51</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">setDoc</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">52</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">52</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(),</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">53</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">53</div>
        <div class="code hidden svelte-19djgjm">      <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PartialWithFieldValue</span>&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">54</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">54</div>
        <div class="code hidden svelte-19djgjm">      { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">55</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">55</div>
        <div class="code hidden svelte-19djgjm">    );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">56</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">56</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">57</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">57</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">set</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">58</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">58</div>
        <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">59</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">59</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">60</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">60</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {</div></details>

<div class="fromLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">1</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">2</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">DocumentReference</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">3</div>
  <div class="code hidden svelte-19djgjm">  onSnapshot,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">4</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title class_">PartialWithFieldValue</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">5</div>
  <div class="code hidden svelte-19djgjm">  setDoc,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">6</div>
  <div class="code hidden svelte-19djgjm">} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">7</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">8</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">9</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">10</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">11</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">12</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">12</div>
  <div class="code hidden svelte-19djgjm">{</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">13</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">13</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">14</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">14</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">15</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">15</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">16</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">16</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> debounceDelayMs: <span class="hljs-built_in">number</span> = <span class="hljs-number">1000</span></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">17</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">17</div>
  <div class="code hidden svelte-19djgjm">  </span>) {}</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">18</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">18</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">19</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">19</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> connected = <span class="hljs-literal">false</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">20</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">20</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">21</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">21</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">stageStore</span>: <span class="hljs-title class_">Writable</span>&lt;<span class="hljs-title class_">Partial</span>&lt;T&gt;&gt; = <span class="hljs-title function_">writable</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">22</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">22</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">localStore</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt; = <span class="hljs-title function_">derived</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">23</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">23</div>
  <div class="code hidden svelte-19djgjm">    [<span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>],</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">24</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">24</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-function">(<span class="hljs-params">[remote, stage]</span>) =&gt;</span> ({ ...remote, ...stage })</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">25</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">25</div>
  <div class="code hidden svelte-19djgjm">  );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">26</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">26</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">27</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">27</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStore</span>.<span class="hljs-property">subscribe</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">28</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">28</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">29</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">29</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">30</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">30</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">31</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">31</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">32</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">32</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">33</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">33</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">34</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">34</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">35</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">35</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">36</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">36</div>
  <div class="code hidden svelte-19djgjm">        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">37</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">37</div>
  <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">38</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">38</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">39</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">39</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">let</span> <span class="hljs-attr">timer</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">40</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">40</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">stageState</span>) =&gt;</span> {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">41</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">41</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (timer !== <span class="hljs-literal">undefined</span>) <span class="hljs-built_in">clearTimeout</span>(timer);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">42</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">42</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(stageState).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">43</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">43</div>
  <div class="code hidden svelte-19djgjm">      timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">push</span>(stageState), <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceDelayMs</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">44</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">44</div>
  <div class="code hidden svelte-19djgjm">    });</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">45</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">45</div>
  <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">46</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">46</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">47</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">47</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">async</span> <span class="hljs-title function_">push</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">48</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">48</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">49</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">49</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">50</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">50</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">51</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">51</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">setDoc</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">52</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">52</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(),</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">53</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">53</div>
  <div class="code hidden svelte-19djgjm">      <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PartialWithFieldValue</span>&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">54</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">54</div>
  <div class="code hidden svelte-19djgjm">      { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">55</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">55</div>
  <div class="code hidden svelte-19djgjm">    );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">56</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">56</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">57</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">57</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">set</span>({});</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">58</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">58</div>
  <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">59</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">59</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">60</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">60</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">61</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">61</div>
  <div class="code same svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ ...state, ...patch }));</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">62</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">62</div>
  <div class="code same svelte-19djgjm">  }</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">63</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">63</div>
  <div class="code same svelte-19djgjm"> </div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">64</div>
  <div class="code added svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">fields</span>: <span class="hljs-title class_">Partial</span>&lt;</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">65</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-title class_">Record</span>&lt;keyof T, <span class="hljs-title class_">FirestoreWritableField</span>&lt;T, keyof T&gt;&gt;</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">66</div>
  <div class="code added svelte-19djgjm">  &gt; = {};</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">67</div>
  <div class="code added svelte-19djgjm"> </div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">64</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">68</div>
  <div class="code same svelte-19djgjm">  getField&lt;K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">key</span>: K): <span class="hljs-title class_">FirestoreWritableField</span>&lt;T, K&gt; {</div>

<div class="fromLine removed svelte-19djgjm" aria-hidden="true">65</div>
  <div class="toLine removed svelte-19djgjm" aria-hidden="true"> </div>
  <div class="code removed svelte-19djgjm">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FirestoreWritableField</span>(<span class="hljs-variable language_">this</span>, key);</div>

<div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">69</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-keyword">if</span> (!(key <span class="hljs-keyword">in</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">fields</span>))</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">70</div>
  <div class="code added svelte-19djgjm">      <span class="hljs-variable language_">this</span>.<span class="hljs-property">fields</span>[key] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FirestoreWritableField</span>(<span class="hljs-variable language_">this</span>, key);</div><div class="fromLine added svelte-19djgjm" aria-hidden="true"> </div>
  <div class="toLine added svelte-19djgjm" aria-hidden="true">71</div>
  <div class="code added svelte-19djgjm">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">fields</span>[key] <span class="hljs-keyword">as</span> <span class="hljs-title class_">FirestoreWritableField</span>&lt;T, K&gt;;</div>

<div class="fromLine same svelte-19djgjm" aria-hidden="true">66</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">72</div>
  <div class="code same svelte-19djgjm">  }</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">67</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">73</div>
  <div class="code same svelte-19djgjm">}</div><div class="fromLine same svelte-19djgjm" aria-hidden="true">68</div>
  <div class="toLine same svelte-19djgjm" aria-hidden="true">74</div>
  <div class="code same svelte-19djgjm"> </div><details class="svelte-19djgjm"><summary class="svelte-19djgjm">&lt;Show 26 identical lines&gt;</summary>
    <div class="fromLine hidden svelte-19djgjm" aria-hidden="true">69</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">75</div>
        <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritableField</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;, K <span class="hljs-keyword">extends</span> keyof T&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">70</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">76</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Writable</span>&lt;T[K]&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">71</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">77</div>
        <div class="code hidden svelte-19djgjm">{</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">72</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">78</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">73</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">79</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> parent: FirestoreWritable&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">74</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">80</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> key: K</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">75</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">81</div>
        <div class="code hidden svelte-19djgjm">  </span>) {}</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">76</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">82</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">77</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">83</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">derivedStore</span>: <span class="hljs-title class_">Readable</span>&lt;T[K]&gt; = <span class="hljs-title function_">derived</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">78</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">84</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">79</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">85</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-function">(<span class="hljs-params">parentValue</span>) =&gt;</span> parentValue[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>]</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">80</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">86</div>
        <div class="code hidden svelte-19djgjm">  );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">81</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">87</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> subscribe = <span class="hljs-variable language_">this</span>.<span class="hljs-property">derivedStore</span>.<span class="hljs-property">subscribe</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">82</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">88</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> push = <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>.<span class="hljs-property">push</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">83</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">89</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">84</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">90</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">set</span>(<span class="hljs-params">value: T[K]</span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">85</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">91</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">const</span> <span class="hljs-attr">patch</span>: <span class="hljs-title class_">Partial</span>&lt;T&gt; = {};</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">86</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">92</div>
        <div class="code hidden svelte-19djgjm">    patch[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>] = value;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">87</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">93</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>.<span class="hljs-title function_">commit</span>(patch);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">88</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">94</div>
        <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">89</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">95</div>
        <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">90</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">96</div>
        <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">update</span>(<span class="hljs-params">updater: (value: T[K]) =&gt; T[K]</span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">91</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">97</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">const</span> oldValue = <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">derivedStore</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">92</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">98</div>
        <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">set</span>(<span class="hljs-title function_">updater</span>(oldValue));</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">93</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">99</div>
        <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">94</div>
        <div class="toLine hidden svelte-19djgjm" aria-hidden="true">100</div>
        <div class="code hidden svelte-19djgjm">}</div></details>

<div class="fromLine hidden svelte-19djgjm" aria-hidden="true">69</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">75</div>
  <div class="code hidden svelte-19djgjm"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritableField</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;, K <span class="hljs-keyword">extends</span> keyof T&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">70</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">76</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Writable</span>&lt;T[K]&gt;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">71</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">77</div>
  <div class="code hidden svelte-19djgjm">{</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">72</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">78</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">73</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">79</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> parent: FirestoreWritable&lt;T&gt;,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">74</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">80</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> key: K</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">75</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">81</div>
  <div class="code hidden svelte-19djgjm">  </span>) {}</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">76</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">82</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">77</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">83</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">derivedStore</span>: <span class="hljs-title class_">Readable</span>&lt;T[K]&gt; = <span class="hljs-title function_">derived</span>(</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">78</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">84</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>,</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">79</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">85</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-function">(<span class="hljs-params">parentValue</span>) =&gt;</span> parentValue[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>]</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">80</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">86</div>
  <div class="code hidden svelte-19djgjm">  );</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">81</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">87</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> subscribe = <span class="hljs-variable language_">this</span>.<span class="hljs-property">derivedStore</span>.<span class="hljs-property">subscribe</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">82</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">88</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> push = <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>.<span class="hljs-property">push</span>;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">83</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">89</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">84</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">90</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">set</span>(<span class="hljs-params">value: T[K]</span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">85</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">91</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">const</span> <span class="hljs-attr">patch</span>: <span class="hljs-title class_">Partial</span>&lt;T&gt; = {};</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">86</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">92</div>
  <div class="code hidden svelte-19djgjm">    patch[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>] = value;</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">87</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">93</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>.<span class="hljs-title function_">commit</span>(patch);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">88</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">94</div>
  <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">89</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">95</div>
  <div class="code hidden svelte-19djgjm"> </div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">90</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">96</div>
  <div class="code hidden svelte-19djgjm">  <span class="hljs-title function_">update</span>(<span class="hljs-params">updater: (value: T[K]) =&gt; T[K]</span>) {</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">91</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">97</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-keyword">const</span> oldValue = <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">derivedStore</span>);</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">92</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">98</div>
  <div class="code hidden svelte-19djgjm">    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">set</span>(<span class="hljs-title function_">updater</span>(oldValue));</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">93</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">99</div>
  <div class="code hidden svelte-19djgjm">  }</div><div class="fromLine hidden svelte-19djgjm" aria-hidden="true">94</div>
  <div class="toLine hidden svelte-19djgjm" aria-hidden="true">100</div>
  <div class="code hidden svelte-19djgjm">}</div></code>

<code class="sr-code svelte-12l7s60"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">DocumentReference</span>,
  onSnapshot,
  <span class="hljs-title class_">PartialWithFieldValue</span>,
  setDoc,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;firebase/firestore&quot;</span>;
<span class="hljs-keyword">import</span> { get_store_value } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/internal&quot;</span>;
<span class="hljs-keyword">import</span> { derived, <span class="hljs-title class_">Readable</span>, <span class="hljs-title class_">Writable</span>, writable } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;svelte/store&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritable</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;
  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Readable</span>&lt;T&gt;
{
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> documentSupplier: () =&gt; DocumentReference&lt;T&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> initial: T,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> debounceDelayMs: <span class="hljs-built_in">number</span> = <span class="hljs-number">1000</span>
  </span>) {}

  <span class="hljs-keyword">private</span> connected = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">remoteStore</span>: <span class="hljs-title class_">Writable</span>&lt;T&gt; = <span class="hljs-title function_">writable</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>);
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">stageStore</span>: <span class="hljs-title class_">Writable</span>&lt;<span class="hljs-title class_">Partial</span>&lt;T&gt;&gt; = <span class="hljs-title function_">writable</span>({});
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">localStore</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt; = <span class="hljs-title function_">derived</span>(
    [<span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>],
    <span class="hljs-function">(<span class="hljs-params">[remote, stage]</span>) =&gt;</span> ({ ...remote, ...stage })
  );
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Readable</span>&lt;T&gt;[<span class="hljs-string">&quot;subscribe&quot;</span>] =
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">localStore</span>.<span class="hljs-property">subscribe</span>;

  <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Already connected&quot;</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-title function_">onSnapshot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(), <span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> data = snapshot.<span class="hljs-title function_">data</span>();
      <span class="hljs-keyword">if</span> (data !== <span class="hljs-literal">undefined</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteStore</span>.<span class="hljs-title function_">set</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">initial</span>, ...data });
    });

    <span class="hljs-keyword">let</span> <span class="hljs-attr">timer</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">stageState</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (timer !== <span class="hljs-literal">undefined</span>) <span class="hljs-built_in">clearTimeout</span>(timer);
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(stageState).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
      timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">push</span>(stageState), <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceDelayMs</span>);
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">push</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">connected</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Store has not been connected to firestore&quot;</span>);

    <span class="hljs-keyword">await</span> <span class="hljs-title function_">setDoc</span>(
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">documentSupplier</span>(),
      <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">PartialWithFieldValue</span>&lt;T&gt;,
      { <span class="hljs-attr">merge</span>: <span class="hljs-literal">true</span> }
    );

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">set</span>({});
  }

  <span class="hljs-title function_">commit</span>(<span class="hljs-params">patch: Partial&lt;T&gt;</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stageStore</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ ...state, ...patch }));
  }

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">fields</span>: <span class="hljs-title class_">Partial</span>&lt;
    <span class="hljs-title class_">Record</span>&lt;keyof T, <span class="hljs-title class_">FirestoreWritableField</span>&lt;T, keyof T&gt;&gt;
  &gt; = {};

  getField&lt;K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">key</span>: K): <span class="hljs-title class_">FirestoreWritableField</span>&lt;T, K&gt; {
    <span class="hljs-keyword">if</span> (!(key <span class="hljs-keyword">in</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">fields</span>))
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">fields</span>[key] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FirestoreWritableField</span>(<span class="hljs-variable language_">this</span>, key);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">fields</span>[key] <span class="hljs-keyword">as</span> <span class="hljs-title class_">FirestoreWritableField</span>&lt;T, K&gt;;
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FirestoreWritableField</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;, K <span class="hljs-keyword">extends</span> keyof T&gt;
  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Writable</span>&lt;T[K]&gt;
{
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> parent: FirestoreWritable&lt;T&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> key: K
  </span>) {}

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">derivedStore</span>: <span class="hljs-title class_">Readable</span>&lt;T[K]&gt; = <span class="hljs-title function_">derived</span>(
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>,
    <span class="hljs-function">(<span class="hljs-params">parentValue</span>) =&gt;</span> parentValue[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>]
  );
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> subscribe = <span class="hljs-variable language_">this</span>.<span class="hljs-property">derivedStore</span>.<span class="hljs-property">subscribe</span>;
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> push = <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>.<span class="hljs-property">push</span>;

  <span class="hljs-title function_">set</span>(<span class="hljs-params">value: T[K]</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">patch</span>: <span class="hljs-title class_">Partial</span>&lt;T&gt; = {};
    patch[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>] = value;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>.<span class="hljs-title function_">commit</span>(patch);
  }

  <span class="hljs-title function_">update</span>(<span class="hljs-params">updater: (value: T[K]) =&gt; T[K]</span>) {
    <span class="hljs-keyword">const</span> oldValue = <span class="hljs-title function_">get_store_value</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">derivedStore</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">set</span>(<span class="hljs-title function_">updater</span>(oldValue));
  }
}</code></figure>

  <p>With that, we&#39;re at the current version!
    I&#39;m sure we&#39;ll make more changes in future - all the <code>get_store_value</code> calls are pretty inefficient and begging to be replaced.
    However, we&#39;re nitpicking at magic by this point.
  </p>

  <p>In just a few lines of code, we can create a two-way real-time database binding.
    We can cache the changes, reducing load and minimising cost.
    We can synchronise across tabs, windows, devices, and across the world.
  </p>

  <h2>Conclusion</h2>

  <p>I&#39;m not saying that you should take our code and use it yourself (but if you want to, <a href="https://github.com/stevenwaterman/Lexoral/blob/stage/frontend/editor/src/utils/firestoreWritable.ts">you can</a>).
    I <em>am</em> saying that cloud-native development is a crazy, magical place, where you need to think outside of the box.
    Creating our custom store implementation was a slow process, where we had a problem, fixed it, and moved on to the next one.
    There was no grand vision, just an emergent solution based on the problems we faced.
  </p>

  <p>It&#39;s easy to get stuck in the patterns of what you&#39;re used to doing.
    I&#39;m new to cloud-native development, and a solution based on my old ways of thinking would have looked very different.
    It would be full of http calls, manual state management, and probably full of bugs too.
  </p>

  <p>By allowing myself to think outside the box, the solution is much nicer.
    While I&#39;ve always enjoyed working <em>on</em> the data layer, I finally have one that I enjoy working <em>with</em>.
  </p></div></article></div>

    

<div class="textContainer svelte-11sshxl" style="position: sticky; top: 1em;"><div class="authorCol svelte-v44y6m"><div class="details svelte-v44y6m"><img src="/assets/blog/authors/SteWaterman.jpg" alt="Steven Waterman" class="svelte-v44y6m">
      <h2 class="name svelte-v44y6m">Steven Waterman</h2>
      <p class="job svelte-v44y6m">Lexoral Founder</p>
      <p class="bio">I&#39;ve spent my career building software to make people&#39;s lives easier, including Lexoral. It&#39;s my full-time job, and I&#39;m always happy to chat with you - feel free to get in touch!</p></div>
    
    <ul class="links svelte-v44y6m"><li class="svelte-v44y6m"><a href="mailto:steven@lexoral.com" class="svelte-v44y6m"><svg id="" class="svelte-fa svelte-1cj2gr0" style="height:1em;vertical-align:-.125em;transform-origin:center;overflow:visible" viewBox="0 0 512 512" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg"><g transform="translate(256 256)" transform-origin="128 0"><g transform="translate(0,0) scale(1,1)"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z" fill="currentColor" transform="translate(-256 -256)"></path></g></g></svg> <span class="linkText svelte-v44y6m">steven@lexoral.com</span></a></li>

      <li class="svelte-v44y6m"><a href="https://calendly.com/lexoral/office-hours" class="svelte-v44y6m"><svg id="" class="svelte-fa svelte-1cj2gr0" style="height:1em;vertical-align:-.125em;transform-origin:center;overflow:visible" viewBox="0 0 448 512" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg"><g transform="translate(224 256)" transform-origin="112 0"><g transform="translate(0,0) scale(1,1)"><path d="M436 160H12c-6.627 0-12-5.373-12-12v-36c0-26.51 21.49-48 48-48h48V12c0-6.627 5.373-12 12-12h40c6.627 0 12 5.373 12 12v52h128V12c0-6.627 5.373-12 12-12h40c6.627 0 12 5.373 12 12v52h48c26.51 0 48 21.49 48 48v36c0 6.627-5.373 12-12 12zM12 192h424c6.627 0 12 5.373 12 12v260c0 26.51-21.49 48-48 48H48c-26.51 0-48-21.49-48-48V204c0-6.627 5.373-12 12-12zm333.296 95.947l-28.169-28.398c-4.667-4.705-12.265-4.736-16.97-.068L194.12 364.665l-45.98-46.352c-4.667-4.705-12.266-4.736-16.971-.068l-28.397 28.17c-4.705 4.667-4.736 12.265-.068 16.97l82.601 83.269c4.667 4.705 12.265 4.736 16.97.068l142.953-141.805c4.705-4.667 4.736-12.265.068-16.97z" fill="currentColor" transform="translate(-224 -256)"></path></g></g></svg> <span class="linkText svelte-v44y6m">Office Hours</span></a></li>

      <li class="svelte-v44y6m"><a href="https://github.com/StevenWaterman/" class="svelte-v44y6m"><svg id="" class="svelte-fa svelte-1cj2gr0" style="height:1em;vertical-align:-.125em;transform-origin:center;overflow:visible" viewBox="0 0 496 512" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg"><g transform="translate(248 256)" transform-origin="124 0"><g transform="translate(0,0) scale(1,1)"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z" fill="currentColor" transform="translate(-248 -256)"></path></g></g></svg> <span class="linkText svelte-v44y6m">@StevenWaterman</span></a></li>

      <li class="svelte-v44y6m"><a href="https://twitter.com/SteWaterman/" class="svelte-v44y6m"><svg id="" class="svelte-fa svelte-1cj2gr0" style="height:1em;vertical-align:-.125em;transform-origin:center;overflow:visible" viewBox="0 0 512 512" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg"><g transform="translate(256 256)" transform-origin="128 0"><g transform="translate(0,0) scale(1,1)"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z" fill="currentColor" transform="translate(-256 -256)"></path></g></g></svg> <span class="linkText svelte-v44y6m">@SteWaterman</span></a></li>

      <li class="svelte-v44y6m"><a href="https://twitch.tv/Lexoral/" class="svelte-v44y6m"><svg id="" class="svelte-fa svelte-1cj2gr0" style="height:1em;vertical-align:-.125em;transform-origin:center;overflow:visible" viewBox="0 0 512 512" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg"><g transform="translate(256 256)" transform-origin="128 0"><g transform="translate(0,0) scale(1,1)"><path d="M391.17,103.47H352.54v109.7h38.63ZM285,103H246.37V212.75H285ZM120.83,0,24.31,91.42V420.58H140.14V512l96.53-91.42h77.25L487.69,256V0ZM449.07,237.75l-77.22,73.12H294.61l-67.6,64v-64H140.14V36.58H449.07Z" fill="currentColor" transform="translate(-256 -256)"></path></g></g></svg> <span class="linkText svelte-v44y6m">@Lexoral</span></a></li>

      <li class="svelte-v44y6m"><a href="https://www.linkedin.com/in/steven-waterman/" class="svelte-v44y6m"><svg id="" class="svelte-fa svelte-1cj2gr0" style="height:1em;vertical-align:-.125em;transform-origin:center;overflow:visible" viewBox="0 0 448 512" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg"><g transform="translate(224 256)" transform-origin="112 0"><g transform="translate(0,0) scale(1,1)"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z" fill="currentColor" transform="translate(-224 -256)"></path></g></g></svg> <span class="linkText svelte-v44y6m">@steven-waterman</span></a></li>

      <li class="svelte-v44y6m"><a href="https://www.stevenwaterman.uk" class="svelte-v44y6m"><svg id="" class="svelte-fa svelte-1cj2gr0" style="height:1em;vertical-align:-.125em;transform-origin:center;overflow:visible" viewBox="0 0 496 512" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg"><g transform="translate(248 256)" transform-origin="124 0"><g transform="translate(0,0) scale(1,1)"><path d="M336.5 160C322 70.7 287.8 8 248 8s-74 62.7-88.5 152h177zM152 256c0 22.2 1.2 43.5 3.3 64h185.3c2.1-20.5 3.3-41.8 3.3-64s-1.2-43.5-3.3-64H155.3c-2.1 20.5-3.3 41.8-3.3 64zm324.7-96c-28.6-67.9-86.5-120.4-158-141.6 24.4 33.8 41.2 84.7 50 141.6h108zM177.2 18.4C105.8 39.6 47.8 92.1 19.3 160h108c8.7-56.9 25.5-107.8 49.9-141.6zM487.4 192H372.7c2.1 21 3.3 42.5 3.3 64s-1.2 43-3.3 64h114.6c5.5-20.5 8.6-41.8 8.6-64s-3.1-43.5-8.5-64zM120 256c0-21.5 1.2-43 3.3-64H8.6C3.2 212.5 0 233.8 0 256s3.2 43.5 8.6 64h114.6c-2-21-3.2-42.5-3.2-64zm39.5 96c14.5 89.3 48.7 152 88.5 152s74-62.7 88.5-152h-177zm159.3 141.6c71.4-21.2 129.4-73.7 158-141.6h-108c-8.8 56.9-25.6 107.8-50 141.6zM19.3 352c28.6 67.9 86.5 120.4 158 141.6-24.4-33.8-41.2-84.7-50-141.6h-108z" fill="currentColor" transform="translate(-248 -256)"></path></g></g></svg> <span class="linkText svelte-v44y6m">www.stevenwaterman.uk</span></a></li></ul></div></div></div>
  
  
  <div></div> 
  <section class="DiagonalSection svelte-11qf40o  flatBottom"><div class="background svelte-11qf40o"></div>

  <div id="blog-cta" class="textContainer svelte-11qf40o"><h2 class="svelte-11qf40o">Get Started</h2>
    <p class="svelte-11qf40o">Create your account
      <br>and try Lexoral for free</p>
    <div class="grid svelte-1gpdmnq"><div class="textCol1 svelte-1gpdmnq"><p>Experience pain-free transcription today.
      </p>

      <p>Our AI transcribes your data automatically, asking for help where needed.
        All the quality of doing it by hand, in a fraction of the time.
      </p>

      <p>15 minutes of credit for all new users
      </p></div>
    
    <a class="LinkButton svelte-tlnb84" rel="external" href="/dashboard/auth/signup" target="_self">Sign up freeÂ <span class="arrow svelte-tlnb84">&gt;</span></a>

    <div class="textCol2 svelte-1gpdmnq"><p class="heading svelte-1gpdmnq">After the trial?</p>
      <p>Our pricing is simple:<br>Â£6 per hour of transcription</p>
      <p>Only pay for what you use</p></div>
    <a class="LinkButton svelte-tlnb84" href="/#pricing" target="_self">PricingÂ <span class="arrow svelte-tlnb84">&gt;</span></a>
  
    <div class="textCol3 svelte-1gpdmnq"><p class="heading svelte-1gpdmnq">Want to know more?</p>
      <p>Learn how we can help make your transcription easy</p>
      <p>Visit our home page for more</p></div>
    <a class="LinkButton svelte-tlnb84" href="/" target="_self">Learn moreÂ <span class="arrow svelte-tlnb84">&gt;</span></a></div></div></section></div>

<footer class="svelte-433wos"><img class="logo svelte-433wos" src="/assets/smallBrand.svg" alt="The Lexoral Logo">
  <div class="outerGrid svelte-433wos"><h3 class="svelte-433wos">Product</h3>
    <ul class="svelte-433wos"><li class="svelte-433wos"><a href="/dashboard" class="svelte-433wos">Dashboard</a></li>
      <li class="svelte-433wos"><a href="/dashboard/auth/signup" class="svelte-433wos">Sign Up</a></li>
      <li class="svelte-433wos"><a href="/demo" class="svelte-433wos">Demo</a></li>
      <li class="svelte-433wos"><a href="/privacy" class="svelte-433wos">Privacy Policy</a></li>
      <li class="svelte-433wos"><a href="/terms" class="svelte-433wos">Terms of Service</a></li></ul>

    <h3 class="svelte-433wos">Community</h3>
    <ul class="svelte-433wos"><li class="svelte-433wos"><a href="/blog" class="svelte-433wos">Blog</a></li>
      <li class="svelte-433wos"><a href="https://join.slack.com/t/lexoral-users/shared_invite/zt-yk0j76n5-KcQwnmCJ7FKkLsj_ik05Pw" class="svelte-433wos">Slack</a></li>
      <li class="svelte-433wos"><a href="https://twitter.com/lexoral/" class="svelte-433wos">Twitter</a></li>
      <li class="svelte-433wos"><a href="https://github.com/stevenwaterman/Lexoral/" class="svelte-433wos">GitHub</a></li>
      <li class="svelte-433wos"><a href="https://www.twitch.tv/lexoral" class="svelte-433wos">Twitch</a></li></ul>

    <h3 class="contactHeader svelte-433wos">Contact</h3>
    <div class="contactBody svelte-433wos"><p class="svelte-433wos">Email: <a href="mailto:steven@lexoral.com" class="svelte-433wos">steven@lexoral.com</a></p>
      <p class="svelte-433wos">Lexoral is Open-Source Software<br>published under the <a href="https://github.com/stevenwaterman/Lexoral/blob/stage/LICENSE" class="svelte-433wos">GPL License</a></p>
      <p class="svelte-433wos">Â© Lexoral 2021</p></div></div></footer>


	</body>
</html>
